# 质量工单判断功能优化说明

## 📋 问题分析

根据用户反馈和截图，质量工单检测功能存在以下问题：

### 1. **部分工单未判断**
- 现象：有些工单的"工单性质"列为空
- 原因：AI模型输出不完整或格式问题导致某些行缺失判断结果

### 2. **判断准确率较低**
- 现象：将质量工单误判为非质量工单，或反之
- 原因：
  - 提示词不够详细，判断标准不明确
  - AI模型对边界情况处理不当
  - 缺少关键字段的权重说明

---

## 🔧 优化方案

### 优化1：增强学习阶段提示词

**文件**: `LLM_Detection_System/prompts/quality_learn_rules.txt`

**优化内容**：
1. ✅ 添加统计分析要求，让AI理解数据分布
2. ✅ 明确特征提取任务，关注关键字段
3. ✅ 详细列出质量工单和非质量工单的典型特征
4. ✅ 强调关键字段的权重和优先级
5. ✅ 提供边界情况的处理原则

**关键改进**：
```
- 判定依据：最重要的判断线索
- 服务项目或故障现象：包含"质量鉴定"→质量工单；包含"安装/调试"→非质量工单
- 关键词识别：质量工单（坏了、损坏、漏、裂、断、烧、短路）
- 关键词识别：非质量工单（安装、调试、水压、水质、使用不当）
```

---

### 优化2：增强应用阶段提示词

**文件**: `LLM_Detection_System/prompts/quality_apply_rules.txt`

**优化内容**：
1. ✅ 提供逐行判断的详细步骤
2. ✅ 明确判断优先级（服务项目 > 判定依据 > 其他字段）
3. ✅ 详细列出判断标准和特殊情况处理
4. ✅ 强调输出完整性要求（必须输出所有行，每行都要有判断）
5. ✅ 提供更多输出示例

**判断优先级**：
```
1. 服务项目或故障现象（最重要）
   - 包含"质量鉴定" → 质量工单
   - 包含"安装/调试/加装" → 非质量工单

2. 判定依据
   - 明确说明问题原因

3. 来电内容、现场诊断、处理方案
   - 综合分析问题性质
```

---

### 优化3：增强质量判断提示词

**文件**: `LLM_Detection_System/modules/excel/processor.py` (第464-524行)

**优化内容**：
1. ✅ 详细的判断标准（质量工单 vs 非质量工单）
2. ✅ 明确的判断优先级
3. ✅ 特殊情况处理规则
4. ✅ 强调每行都必须有判断结果
5. ✅ 提供更多示例

**判断标准**：

**【质量工单】- 产品本身的质量问题**：
- ✓ 零部件损坏、故障、失效
- ✓ 产品缺陷、制程问题、设计缺陷
- ✓ 服务项目包含"质量鉴定"
- ✓ 需要更换零部件且原因是产品质量问题

**【非质量工单】- 非产品质量问题**：
- ✓ 安装、调试、加装、改装、移机等服务
- ✓ 环境因素导致（水压、水质、电压）
- ✓ 用户使用不当、操作错误
- ✓ 正常的维护保养、滤芯到期更换

---

### 优化4：添加后处理机制

**文件**: `LLM_Detection_System/modules/excel/processor.py` (第572-713行)

**新增功能**：

#### 4.1 `_ensure_quality_judgment()` 方法
确保所有行都有工单性质判断，对空值进行智能填充

**功能**：
- ✅ 检测"工单性质"列的空值
- ✅ 对空值进行智能判断填充
- ✅ 验证判断结果只能是"质量工单"或"非质量工单"
- ✅ 修正异常值

#### 4.2 `_smart_quality_judgment()` 方法
基于规则的智能工单性质判断

**判断逻辑**：
1. **优先检查服务项目字段**
   - 包含"质量鉴定"或"产品质量" → 质量工单
   - 包含"安装"、"调试"、"加装" → 非质量工单

2. **检查判定依据字段**
   - 匹配质量工单关键词 → 质量工单
   - 匹配非质量工单关键词 → 非质量工单

3. **综合所有字段判断**
   - 计算质量工单关键词得分
   - 计算非质量工单关键词得分
   - 比较得分，选择较高的类别

4. **默认策略**
   - 无法判断时，默认为"非质量工单"（保守原则）

**关键词库**：

**质量工单关键词**：
```python
'质量鉴定', '产品质量', '产品缺陷', '制程问题', '来料问题',
'损坏', '坏了', '漏', '裂', '断', '烧', '短路', '失灵',
'不工作', '异响', '故障', '缺陷', '质量问题'
```

**非质量工单关键词**：
```python
'安装', '调试', '加装', '改装', '移机', '维护',
'水压', '水质', '电压', '环境', '使用不当', '操作错误',
'正常损耗', '到期更换', '保养'
```

---

## 📊 优化效果预期

### 1. **完整性提升**
- ✅ 所有工单都会有明确的性质判断
- ✅ 不再出现空值情况
- ✅ 异常值会被自动修正

### 2. **准确率提升**
- ✅ 更详细的判断标准和示例
- ✅ 明确的字段优先级
- ✅ 基于规则的后处理兜底机制
- ✅ 关键词匹配辅助判断

### 3. **一致性提升**
- ✅ 统一的判断标准
- ✅ 明确的边界情况处理
- ✅ 降低AI模型的随机性（temperature=0.3）

---

## 🧪 测试建议

### 测试步骤

1. **重启服务器**
   ```bash
   # 停止当前服务器（Ctrl+C）
   python LLM_Detection_System/app.py
   ```

2. **访问质量工单检测页面**
   ```
   http://localhost:5000/excel/quality-check
   ```

3. **上传测试数据**
   - 使用之前有问题的测试文件
   - 或使用 `data/质量问题判断测试数据-100.xlsx`

4. **执行检测并验证结果**
   - ✅ 检查是否所有行都有"工单性质"判断
   - ✅ 检查判断结果是否合理
   - ✅ 对比优化前后的准确率

### 验证要点

#### 完整性验证
- [ ] 所有行的"工单性质"列都有值
- [ ] 没有空值、null、nan等情况
- [ ] 所有值都是"质量工单"或"非质量工单"

#### 准确性验证（抽样检查）
- [ ] 包含"质量鉴定"的工单 → 应判断为"质量工单"
- [ ] 包含"安装"、"调试"的工单 → 应判断为"非质量工单"
- [ ] 零部件损坏、漏水等 → 应判断为"质量工单"
- [ ] 水压、水质、环境问题 → 应判断为"非质量工单"

---

## 📝 优化文件清单

### 修改的文件

1. ✅ `LLM_Detection_System/prompts/quality_learn_rules.txt`
   - 增强学习阶段提示词
   - 添加详细的特征说明和判断标准

2. ✅ `LLM_Detection_System/prompts/quality_apply_rules.txt`
   - 增强应用阶段提示词
   - 添加判断优先级和详细步骤

3. ✅ `LLM_Detection_System/modules/excel/processor.py`
   - 优化质量判断提示词（第464-524行）
   - 添加后处理机制（第555-558行）
   - 新增 `_ensure_quality_judgment()` 方法（第572-649行）
   - 新增 `_smart_quality_judgment()` 方法（第651-713行）

---

## 🎯 关键改进点总结

### 1. **三层保障机制**
- **第一层**：优化的AI提示词，提高AI判断准确率
- **第二层**：CSV格式验证和修复，确保数据完整性
- **第三层**：基于规则的后处理，兜底处理空值和异常值

### 2. **明确的判断优先级**
```
服务项目或故障现象 > 判定依据 > 其他字段综合判断
```

### 3. **丰富的关键词库**
- 质量工单关键词：18个
- 非质量工单关键词：15个
- 覆盖常见的故障描述和服务类型

### 4. **保守的默认策略**
- 无法明确判断时，默认为"非质量工单"
- 避免误判导致的质量问题遗漏

---

## 🚀 下一步建议

1. **测试验证**
   - 使用历史数据进行测试
   - 对比优化前后的准确率
   - 收集边界案例

2. **持续优化**
   - 根据测试结果调整关键词库
   - 优化判断规则的权重
   - 收集用户反馈

3. **性能监控**
   - 记录判断结果的分布
   - 统计空值填充的比例
   - 分析误判案例

4. **文档更新**
   - 更新用户使用指南
   - 添加判断标准说明
   - 提供常见问题解答

---

**优化完成时间**：2025-11-13  
**优化版本**：v2.1  
**预期效果**：完整性100%，准确率提升20-30%

