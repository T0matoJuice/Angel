<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ¶å›¾æ£€æµ‹å†å²è®°å½•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
        }

        .back-btn:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            animation: fadeInUp 0.8s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: #666;
        }

        .empty-state .icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #333;
        }

        .empty-state p {
            font-size: 16px;
            margin-bottom: 30px;
        }

        .start-detection-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .start-detection-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .history-list {
            display: grid;
            gap: 20px;
        }

        .history-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid #4a90e2;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .history-item:hover {
            background: #e9ecef;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .history-filename {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* æ¥æºæ ‡ç­¾æ ·å¼ */
        .source-tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .source-tag.source-web {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #90caf9;
        }

        .source-tag.source-api {
            background: #f3e5f5;
            color: #7b1fa2;
            border: 1px solid #ce93d8;
        }

        .history-time {
            font-size: 14px;
            color: #666;
            margin-left: 20px;
        }

        .history-user {
            font-size: 14px;
            color: #667eea;
            font-weight: 600;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .history-user::before {
            content: "ğŸ‘¤";
            font-size: 12px;
        }

        .history-conclusion {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-left: 15px;
            min-width: 80px;
            text-align: center;
        }

        .conclusion-ç¬¦åˆ {
            background: #d4edda;
            color: #155724;
        }

        .conclusion-ä¸ç¬¦åˆ {
            background: #f8d7da;
            color: #721c24;
        }

        .conclusion-åŸºæœ¬ç¬¦åˆ {
            background: #fff3cd;
            color: #856404;
        }

        .conclusion-åŸºæœ¬ä¸ç¬¦åˆ {
            background: #f5c6cb;
            color: #721c24;
        }

        .history-preview {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }

        .view-detail-btn {
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
            margin-right: 10px;
        }

        .view-detail-btn:hover {
            background: #357abd;
        }

        .download-btn {
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
        }

        .download-btn:hover {
            background: #5a6268;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        /* è¯¦æƒ…æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 0;
            border-radius: 15px;
            width: 95%;
            max-width: 1000px;
            max-height: 90vh;
            overflow: hidden;
            animation: slideIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            padding: 30px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .detail-section {
            margin-bottom: 25px;
        }

        .detail-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .detail-content {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .detail-conclusion {
            display: inline-block;
            font-weight: 600;
            font-size: 16px;
            color: #333;
        }

        .download-report-btn {
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 30px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .download-report-btn:hover {
            background: linear-gradient(135deg, #357abd 0%, #2968a3 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
        }

        .download-section {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 24px;
            }

            .content {
                padding: 20px;
            }

            .history-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .history-time {
                margin-left: 0;
            }

            .modal-content {
                width: 95%;
                margin: 10% auto;
            }

            .modal-body {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <a href="/drawing" class="back-btn">
        <span>â†</span>
        <span>è¿”å›åˆ¶å›¾æ£€æµ‹ç³»ç»Ÿ</span>
    </a>

    <div class="container">
        <div class="header">
            <h1>ğŸ“‹ åˆ¶å›¾æ£€æµ‹å†å²è®°å½•</h1>
            <p>æŸ¥çœ‹æœ€è¿‘çš„åˆ¶å›¾æ£€æµ‹è®°å½•å’Œè¯¦ç»†æŠ¥å‘Š</p>
        </div>

        <div class="content">
            <div id="historyContent">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>æ­£åœ¨åŠ è½½å†å²è®°å½•...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">æ£€æµ‹è¯¦æƒ…</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- è¯¦æƒ…å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
            </div>
        </div>
    </div>

    <script>
        // é¡µé¢åŠ è½½å®Œæˆåè·å–å†å²è®°å½•
        document.addEventListener('DOMContentLoaded', function() {
            loadHistory();
        });

        // åŠ è½½å†å²è®°å½•
        function loadHistory() {
            fetch('/drawing/api/history')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayHistory(data.records);
                    } else {
                        showError('è·å–å†å²è®°å½•å¤±è´¥: ' + data.error);
                    }
                })
                .catch(error => {
                    showError('ç½‘ç»œé”™è¯¯: ' + error.message);
                });
        }

        // æ˜¾ç¤ºå†å²è®°å½•åˆ—è¡¨
        function displayHistory(records) {
            const content = document.getElementById('historyContent');
            
            if (!records || records.length === 0) {
                content.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ğŸ“</div>
                        <h3>æš‚æ— æ£€æµ‹è®°å½•</h3>
                        <p>æ‚¨è¿˜æ²¡æœ‰è¿›è¡Œè¿‡åˆ¶å›¾æ£€æµ‹ï¼Œå¼€å§‹ç¬¬ä¸€æ¬¡æ£€æµ‹å§ï¼</p>
                        <a href="/drawing/detection" class="start-detection-btn">å¼€å§‹æ£€æµ‹</a>
                    </div>
                `;
                return;
            }

            let html = '<div class="history-list">';
            
            records.forEach(record => {
                const preview = record.detailed_report.length > 100
                    ? record.detailed_report.substring(0, 100) + '...'
                    : record.detailed_report;

                // ç”Ÿæˆæ¥æºæ ‡ç­¾
                const sourceTag = record.source
                    ? `<span class="source-tag source-${record.source_type || 'web'}">${record.source}</span>`
                    : '';

                html += `
                    <div class="history-item" onclick="viewDetail('${record.id}')">
                        <div class="history-header">
                            <div class="history-filename">
                                ${record.original_filename}
                                ${sourceTag}
                            </div>
                            <div>
                                <span class="history-conclusion conclusion-${record.conclusion}">${record.conclusion}</span>
                                <div class="history-time">${record.timestamp}</div>
                            </div>
                        </div>
                        <div class="history-user">ä¼ å…¥å›¾çº¸ç”¨æˆ·: ${record.account || 'æœªçŸ¥'}</div>
                        <div class="history-preview">${preview}</div>
                        <div class="button-group">
                            <button class="view-detail-btn" onclick="event.stopPropagation(); viewDetail('${record.id}')">
                                æŸ¥çœ‹è¯¦æƒ…
                            </button>
                            <button class="download-btn" onclick="event.stopPropagation(); downloadHistoryReport('${record.id}', '${record.original_filename}')">
                                ğŸ“¥ ä¸‹è½½æŠ¥å‘Š
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            content.innerHTML = html;
        }

        // æŸ¥çœ‹è¯¦æƒ…
        function viewDetail(recordId) {
            fetch(`/drawing/api/history/${recordId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showDetailModal(data.record);
                    } else {
                        alert('è·å–è¯¦æƒ…å¤±è´¥: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('ç½‘ç»œé”™è¯¯: ' + error.message);
                });
        }

        // æ˜¾ç¤ºè¯¦æƒ…æ¨¡æ€æ¡†
        function showDetailModal(record) {
            const modal = document.getElementById('detailModal');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');

            title.textContent = `æ£€æµ‹è¯¦æƒ… - ${record.original_filename}`;

            // ç”Ÿæˆæ¥æºæ ‡ç­¾
            const sourceTag = record.source
                ? `<span class="source-tag source-${record.source_type || 'web'}">${record.source}</span>`
                : '';

            // æ˜¾ç¤ºæ£€å…¥è€…å’Œç‰ˆæœ¬ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
            const checkerInfo = record.checker_name
                ? `<div class="detail-section">
                    <div class="detail-label">æ£€å…¥è€…</div>
                    <div class="detail-content">ğŸ‘¤ ${record.checker_name}</div>
                </div>`
                : '';

            const versionInfo = record.version
                ? `<div class="detail-section">
                    <div class="detail-label">ç‰ˆæœ¬å·</div>
                    <div class="detail-content">ğŸ“Œ ${record.version}</div>
                </div>`
                : '';

            body.innerHTML = `
                <div class="detail-section">
                    <div class="detail-label">æ–‡ä»¶åç§°</div>
                    <div class="detail-content">${record.original_filename}</div>
                </div>

                <div class="detail-section">
                    <div class="detail-label">è®°å½•æ¥æº</div>
                    <div class="detail-content">${sourceTag}</div>
                </div>

                <div class="detail-section">
                    <div class="detail-label">ä¼ å…¥å›¾çº¸ç”¨æˆ·</div>
                    <div class="detail-content">ğŸ‘¤ ${record.account || 'æœªçŸ¥'}</div>
                </div>

                ${checkerInfo}
                ${versionInfo}

                <div class="detail-section">
                    <div class="detail-label">æ£€æµ‹æ—¶é—´</div>
                    <div class="detail-content">${record.timestamp}</div>
                </div>

                <div class="detail-section">
                    <div class="detail-label">æ£€æµ‹ç»“è®º</div>
                    <div class="detail-content">${record.conclusion}</div>
                </div>

                <div class="detail-section">
                    <div class="detail-label">è¯¦ç»†æŠ¥å‘Š</div>
                    <div class="detail-content">${record.detailed_report}</div>
                </div>

                <div class="download-section">
                    <button class="download-report-btn" onclick="downloadHistoryReport('${record.id}', '${record.original_filename}')">
                        ğŸ“¥ ä¸‹è½½TXTæŠ¥å‘Š
                    </button>
                </div>
            `;

            modal.style.display = 'block';
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('detailModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // ä¸‹è½½å†å²æŠ¥å‘Š
        function downloadHistoryReport(recordId, filename) {
            // ç›´æ¥é€šè¿‡ GET è¯·æ±‚ä¸‹è½½æŠ¥å‘Š
            // ä½¿ç”¨ fetch + blob æ–¹å¼å®ç°ä¸‹è½½ï¼Œä»¥ä¾¿å¤„ç†é”™è¯¯
            fetch(`/drawing/download-report/${recordId}`)
                .then(response => {
                    if (response.ok) {
                        return response.blob();
                    } else {
                        // å°è¯•è§£æé”™è¯¯ä¿¡æ¯
                        return response.json().then(data => {
                            throw new Error(data.error || 'ä¸‹è½½å¤±è´¥');
                        }).catch(() => {
                            throw new Error('ä¸‹è½½å¤±è´¥');
                        });
                    }
                })
                .then(blob => {
                    // åˆ›å»ºä¸‹è½½é“¾æ¥
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `åˆ¶å›¾æ£€æµ‹æŠ¥å‘Š_${filename || 'report'}_${new Date().toISOString().slice(0,10)}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                })
                .catch(error => {
                    alert('ä¸‹è½½æŠ¥å‘Šå¤±è´¥: ' + error.message);
                });
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const content = document.getElementById('historyContent');
            content.innerHTML = `
                <div class="empty-state">
                    <div class="icon">âŒ</div>
                    <h3>åŠ è½½å¤±è´¥</h3>
                    <p>${message}</p>
                    <button class="start-detection-btn" onclick="loadHistory()">é‡è¯•</button>
                </div>
            `;
        }
    </script>
</body>
</html>
