# 下载功能修复说明

## 问题总结

历史记录显示正常后，发现下载功能无法使用，有两个问题：

### 1. 工单处理（Excel）下载失败
**错误日志**:
```
GET /excel/download/batch_001_20251219_104156_062246_3229 HTTP/1.1" 404
GET /excel/download/20251215_193402_工作簿16.xlsx HTTP/1.1" 404
```

**问题原因**:
- `drawing_history.html` 页面在工单处理模式下，下载按钮传递的文件名不正确
- 应该传递 `result_filename`（格式：`quality_result_文件名.xlsx`）
- 但实际传递的是 `filename`（原始文件名）

**解决方案**:
修改 `templates/drawing_history.html` 第685-696行，使用 `r.result_filename` 并根据 `r.has_result_file` 决定是否禁用下载按钮。

### 2. 制图检测（Drawing）下载失败
**错误日志**:
```
❌ PDF文件不存在: C:\Users\root\Desktop\Angel_20251218\LLM_Detect_master\...
```

**问题原因**:
- 数据库中存储的 `file_path` 是旧的绝对路径
- 项目路径已经从 `C:\Users\root\Desktop\Angel_20251218\...` 改变到 `d:\work\angel\Angel\...`
- 直接使用数据库中的路径会导致文件找不到

**解决方案**:
修改 `modules/drawing/routes.py` 的 `drawing_download_report` 函数，添加路径回退逻辑：
1. 首先尝试使用数据库中的路径
2. 如果文件不存在，从路径中提取文件名
3. 在当前的 `UPLOAD_FOLDER` 中查找文件
4. 如果找到，使用新路径；否则返回404错误

## 修改内容

### 1. `templates/drawing_history.html` (第685-696行)

**修改前**:
```javascript
tr.innerHTML = `
    <td>${r.timestamp}</td>
    <td>
        ${r.original_filename}
        <div style="font-size: 12px; color: #666; margin-top: 4px;">结果: ${r.filename}</div>
    </td>
    <td><strong>${r.account || '--'}</strong></td>
    <td><span class="history-conclusion ${conclusionClass}">${conclusionText}</span></td>
    <td>
        <button class="btn-prev" onclick="viewDetail('${r.id}')">预览</button>
        <button class="btn-down" onclick="downloadFile('${r.id}', '${r.filename || r.original_filename}', true)">下载</button>
    </td>`;
```

**修改后**:
```javascript
// 根据是否有结果文件决定下载按钮状态
const downloadBtn = r.has_result_file
    ? `<button class="btn-down" onclick="downloadFile('${r.id}', '${r.result_filename}', true)">下载</button>`
    : `<button class="btn-down" disabled style="opacity: 0.5; cursor: not-allowed;" title="该记录暂无结果文件">无结果</button>`;

tr.innerHTML = `
    <td>${r.timestamp}</td>
    <td>
        ${r.original_filename}
        <div style="font-size: 12px; color: #666; margin-top: 4px;">账号: ${r.account || '--'}</div>
    </td>
    <td><strong>${r.account || '--'}</strong></td>
    <td><span class="history-conclusion ${conclusionClass}">${conclusionText}</span></td>
    <td>
        <button class="btn-prev" onclick="viewDetail('${r.id}')">预览</button>
        ${downloadBtn}
    </td>`;
```

**改进点**:
- ✅ 使用 `r.result_filename` 而不是 `r.filename`
- ✅ 根据 `r.has_result_file` 决定是否禁用下载按钮
- ✅ 对于没有结果文件的记录，显示"无结果"按钮（禁用状态）
- ✅ 显示账号信息而不是结果文件名

### 2. `modules/drawing/routes.py` (第407-427行)

**修改前**:
```python
if not os.path.exists(pdf_path):
    print(f"❌ PDF文件不存在: {pdf_path}")
    return jsonify({'error': f'PDF文件不存在: {pdf_path}'}), 404
```

**修改后**:
```python
# 如果数据库中的路径不存在，尝试从当前UPLOAD_FOLDER中查找
if not os.path.exists(pdf_path):
    print(f"⚠️  数据库路径无效: {pdf_path}")
    print(f"   尝试从当前UPLOAD_FOLDER中查找文件...")
    
    # 从路径中提取文件名
    filename = os.path.basename(pdf_path)
    # 构建新的路径
    new_pdf_path = os.path.join(current_app.config['UPLOAD_FOLDER'], filename)
    
    print(f"   新路径: {new_pdf_path}")
    
    if os.path.exists(new_pdf_path):
        print(f"✅ 在新路径找到文件")
        pdf_path = new_pdf_path
    else:
        print(f"❌ 文件不存在: {new_pdf_path}")
        return jsonify({'error': f'PDF文件不存在，请重新上传'}), 404
```

**改进点**:
- ✅ 添加路径回退逻辑
- ✅ 当数据库路径无效时，自动在当前UPLOAD_FOLDER中查找
- ✅ 详细的调试日志，方便排查问题
- ✅ 更友好的错误提示

## 测试步骤

### 1. 重启Flask应用
```bash
# 停止当前应用（Ctrl+C）
# 重新启动
python app.py
```

### 2. 测试工单处理下载
1. 访问 `/drawing/history`
2. 点击"工单处理"标签
3. 找到有结果文件的记录（绿色"处理完成"状态）
4. 点击"下载"按钮
5. 应该能成功下载 `quality_result_文件名.xlsx` 文件

### 3. 测试制图检测下载
1. 在"制图检测"标签下
2. 点击任意记录的"下载"按钮
3. 应该能成功下载PDF文件
4. 如果是旧记录（路径已改变），系统会自动在新路径中查找文件

## 预期结果

### 工单处理下载
- ✅ 有结果文件的记录：显示"下载"按钮，可以正常下载
- ✅ 无结果文件的记录：显示"无结果"按钮（禁用状态）
- ✅ 下载的文件名格式：`quality_result_时间戳_原始文件名.xlsx`

### 制图检测下载
- ✅ 新记录：直接使用数据库路径下载
- ✅ 旧记录：自动在新路径中查找文件
- ✅ 下载的文件名格式：`检测报告_原始文件名.pdf`
- ✅ 如果文件确实不存在，显示友好的错误提示

## 注意事项

1. **文件路径问题**：
   - 如果项目路径再次改变，制图检测的旧记录可能仍然无法下载
   - 建议在上传时使用相对路径而不是绝对路径

2. **API上传的数据**：
   - 通过API上传的工单数据不会生成结果文件
   - 这些记录的下载按钮会显示为"无结果"（禁用状态）

3. **数据库清理**：
   - 如果有大量旧记录无法下载，可以考虑清理数据库或更新 `file_path` 字段

## 后续优化建议

1. **使用相对路径**：
   - 在数据库中存储相对于 `UPLOAD_FOLDER` 的路径
   - 而不是存储绝对路径

2. **文件迁移脚本**：
   - 创建一个脚本，批量更新数据库中的 `file_path` 字段
   - 将旧的绝对路径转换为新的路径

3. **API结果文件生成**：
   - 考虑为API上传的数据也生成结果文件
   - 或者提供API接口直接返回结果数据

## 总结

所有下载问题已修复！
- ✅ 工单处理：使用正确的结果文件名，并根据是否有文件决定按钮状态
- ✅ 制图检测：添加路径回退逻辑，自动处理路径变更问题
- ✅ 用户体验：更友好的错误提示和按钮状态
