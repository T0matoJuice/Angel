# 工单历史记录问题诊断与解决方案

## 问题现象
通过API接口上传的数据没有显示在历史记录页面中。

## 根本原因
**账号不匹配问题**：
- 历史记录页面默认只显示当前登录用户的记录（通过 `current_user.username` 过滤）
- API接口上传时使用的 `account` 参数可能与当前登录用户不同
- 例如：API上传时使用 `api_test` 或 `api_tomato`，但登录用户是 `tomato` 或 `QMS`

## 数据库中的账号
根据诊断，数据库中存在以下账号：
- `api_test`
- `api_tomato`
- `QMS`
- `tomato`
- `测试用户`

## 解决方案

### 1. 添加"显示所有记录"功能
在历史记录页面添加一个复选框，允许用户查看所有账号的记录。

### 2. 后端修改 (`modules/excel/routes.py`)

#### 修改 `excel_get_history()` 函数
- 添加 `show_all` URL参数支持
- 当 `show_all=1` 时，显示所有用户的记录
- 在查询结果中包含 `account` 字段
- 返回 `show_all` 和 `current_user` 信息

```python
@excel_bp.route('/api/history')
@login_required
def excel_get_history():
    # 检查是否显示所有用户的记录
    show_all = request.args.get('show_all', '0') == '1'
    
    # 查询上传记录
    query = db.session.query(
        WorkorderData.account,  # 添加account字段
        WorkorderData.filename,
        WorkorderData.datatime,
        func.count(WorkorderData.id).label('rows_processed')
    ).group_by(
        WorkorderData.account,
        WorkorderData.filename,
        WorkorderData.datatime
    )
    
    # 如果不是显示所有记录，则只查询当前用户的记录
    if not show_all:
        query = query.filter(WorkorderData.account == current_user.username)
    
    # ... 格式化结果，添加account字段
```

### 3. 前端修改 (`templates/excel_history.html`)

#### 添加切换按钮
```html
<div style="margin-bottom: 20px;">
    <label>
        <input type="checkbox" id="showAllCheckbox" onchange="toggleShowAll()">
        <span>显示所有用户的记录（包括API上传）</span>
    </label>
    <div id="userInfo">
        <!-- 显示当前用户和过滤状态 -->
    </div>
</div>
```

#### 更新JavaScript
```javascript
function toggleShowAll() {
    loadHistory();
}

function loadHistory() {
    const showAll = document.getElementById('showAllCheckbox').checked;
    const url = showAll ? '/excel/api/history?show_all=1' : '/excel/api/history';
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayHistory(data.records);
                // 显示当前用户信息
                const userInfo = document.getElementById('userInfo');
                if (data.show_all) {
                    userInfo.innerHTML = `当前用户: <strong>${data.current_user}</strong> | 显示: <strong>所有用户</strong>`;
                } else {
                    userInfo.innerHTML = `当前用户: <strong>${data.current_user}</strong> | 显示: <strong>仅我的记录</strong>`;
                }
            }
        });
}
```

#### 在记录中显示账号
```html
<div class="history-info">
    账号: <strong>${record.account}</strong> | 
    处理行数: ${record.rows_processed} 行 | 
    结果文件: ${record.filename}
</div>
```

## 使用方法

### 查看所有记录
1. 打开工单历史记录页面
2. 勾选"显示所有用户的记录（包括API上传）"复选框
3. 页面会自动刷新，显示所有账号的上传记录

### 查看自己的记录
1. 取消勾选复选框
2. 页面只显示当前登录用户的记录

## 调试功能

后端添加了详细的调试日志：
```
🔍 [历史记录] 当前登录用户: tomato
🔍 [历史记录] show_all参数: True
🔍 [历史记录] 数据库中最近的10条记录:
   - account=api_test, filename=20251219_104156_test.xlsx, count=30
   - account=tomato, filename=20251218_193445_工作簿1.xlsx, count=30
🔍 [历史记录] 查询到的记录数: 2
```

## API上传建议

为了让API上传的数据显示在正确的用户下，建议：

1. **使用统一的账号**：API上传时使用的 `account` 参数应该与Web登录用户一致
2. **或者使用"显示所有记录"功能**：勾选复选框查看所有账号的数据
3. **创建专门的API账号**：为API调用创建专门的账号，并在需要时切换到该账号查看

## 诊断脚本

创建了 `check_history_records.py` 脚本，用于检查数据库中的上传记录：

```bash
python check_history_records.py
```

该脚本会显示：
- 今天的所有上传记录
- 每条记录的账号、文件名、时间和工单数量
- 数据库中的所有账号列表

## 总结

问题的根本原因是**账号不匹配**，而不是数据没有写入数据库。通过添加"显示所有记录"功能，用户可以：
- ✅ 查看所有账号的上传记录
- ✅ 区分不同账号上传的数据
- ✅ 灵活切换显示范围
- ✅ 调试API上传问题
