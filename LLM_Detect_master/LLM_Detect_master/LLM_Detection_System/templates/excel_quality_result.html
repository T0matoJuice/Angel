<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´¨é‡å·¥å•åˆ¤å®šç»“æœ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
        }

        .back-btn:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 15px 20px;
            margin-bottom: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #333;
            font-size: 2em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #20c997, #17a2b8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .result-info {
            background: rgba(255, 255, 255, 0.9);
            padding: 12px 15px;
            border-radius: 10px;
            margin: 8px 0;
        }

        .main-container {
            display: flex;
            gap: 20px;
            min-height: 500px;
            max-height: calc(100vh - 300px);
        }

        .left-panel, .right-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            transition: all 0.5s ease;
            flex: 1;
            min-width: 0;
        }

        .left-panel {
            flex: 1;
        }

        .right-panel {
            flex: 1;
        }

        /* å½“åªæ˜¾ç¤ºä¸€ä¸ªé¢æ¿æ—¶å æ»¡å®½åº¦ */
        .left-panel.full-width, .right-panel.full-width {
            flex: 1;
        }

        .panel-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #20c997;
            flex-shrink: 0;
        }

        .table-container {
            flex: 1;
            border: 2px solid #ddd;
            border-radius: 10px;
            background: white;
            overflow: auto;
            margin-top: 10px;
            min-height: 400px;
            max-height: 100%;
            position: relative;
        }
        
        /* å¢å¼ºæ»šåŠ¨æ¡æ ·å¼ - ä½¿å…¶æ›´æ˜æ˜¾ */
        .table-container::-webkit-scrollbar {
            width: 14px;
            height: 14px;
            background: #f8f9fa;
        }
        
        .table-container::-webkit-scrollbar-track {
            background: #e9ecef;
            border-radius: 0;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
        }
        
        .table-container::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, #20c997, #17a2b8);
            border-radius: 7px;
            border: 2px solid #e9ecef;
        }
        
        .table-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(45deg, #17a2b8, #20c997);
            border: 2px solid #dee2e6;
        }
        
        .table-container::-webkit-scrollbar-corner {
            background: #e9ecef;
        }
        .data-table {
            width: 100%;
            min-width: 1500px;
            border-collapse: collapse;
            font-size: 0.85em;
            table-layout: fixed;
        }

        .data-table th {
            background: linear-gradient(45deg, #20c997, #17a2b8);
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #eee;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .basis-cell { white-space: pre-line; max-width: 400px; }
        .diff-highlight { background: #fff3cd !important; }

        

        .right-panel .data-table td {
            max-width: 120px;
        }

        .data-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .data-table tr:hover {
            background: #e8f5f0;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #20c997;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .actions {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-top: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .action-button {
            background: linear-gradient(45deg, #20c997, #17a2b8);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin: 0 10px;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(32, 201, 151, 0.3);
        }

        .action-button.secondary {
            background: linear-gradient(45deg, #6c757d, #495057);
        }

        .action-button.secondary:hover {
            box-shadow: 0 8px 15px rgba(108, 117, 125, 0.3);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                max-height: none;
            }

            .left-panel, .right-panel {
                flex: none;
                min-height: 400px;
            }
            
            .left-panel.full-width, .right-panel.full-width {
                width: 100%;
            }

            .table-container {
                min-height: 300px;
            }

            .data-table {
                font-size: 0.75em;
                min-width: 1000px;
            }

            .data-table th, .data-table td {
                padding: 8px 4px;
            }

            .action-button {
                display: block;
                margin: 10px auto;
                width: 80%;
            }
        }
    </style>
</head>
<body>
    <a href="/excel" class="back-btn">
        <span>â†</span>
        <span>è¿”å›è´¨é‡å·¥å•æ£€æµ‹ç³»ç»Ÿ</span>
    </a>

    <div class="header">
        <h1>ğŸ¯ æ£€æµ‹ç»“æœ</h1>
        <div class="result-info" id="resultInfo">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>å¤§æ¨¡å‹æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...</p>
            </div>
        </div>
        <div class="processing-time" id="processingTime" style="display: none; margin-top: 15px; padding: 10px; background: rgba(32, 201, 151, 0.1); border-radius: 8px; border-left: 4px solid #20c997;">
            <strong>â±ï¸ å¤„ç†è€—æ—¶:</strong> <span id="timeDisplay">0ç§’</span>
        </div>
    </div>

    <div class="main-container">
        <div class="left-panel" id="originalPanel">
            <div class="panel-title">ğŸ“Š åŸå§‹æµ‹è¯•æ•°æ®</div>
            <div class="table-container">
                <table class="data-table" id="originalTable">
                    <tbody>
                        <tr>
                            <td colspan="100%" class="loading">
                                <div class="loading-spinner"></div>
                                æ­£åœ¨åŠ è½½åŸå§‹æ•°æ®...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="right-panel" id="resultPanel" style="display: none;">
            <div class="panel-title">ğŸ¯ æ£€æµ‹ç»“æœ</div>
            <div class="table-container">
                <table class="data-table" id="resultTable">
                    <tbody>
                        <tr>
                            <td colspan="100%" class="loading">
                                <div class="loading-spinner"></div>
                                æ­£åœ¨è¿›è¡ŒAIæ£€æµ‹...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="actions">
        <a href="#" class="action-button" id="downloadExcel" style="display: none;">
            ğŸ“¥ ä¸‹è½½æ£€æµ‹ç»“æœï¼ˆExcelæ ¼å¼ï¼‰
        </a>
        <a href="#" class="action-button" id="downloadCSV" style="display: none;">
            ğŸ“„ ä¸‹è½½æ£€æµ‹ç»“æœï¼ˆCSVæ ¼å¼ï¼‰
        </a>
        <a href="/excel" class="action-button secondary" style="display: none;">
            ğŸ”™ è¿”å›è´¨é‡å·¥å•æ£€æµ‹ç³»ç»Ÿ
        </a>
    </div>

    <script>
        // ä»URLå‚æ•°è·å–æ–‡ä»¶å
        const urlParams = new URLSearchParams(window.location.search);
        const filename = urlParams.get('filename');
        const originalFilename = urlParams.get('original_filename');
        const uniqueFilename = urlParams.get('unique_filename');
        
        // è½®è¯¢ç›¸å…³å˜é‡
        let pollingInterval = null;
        let pollCount = 0;
        let isPollingActive = false;  // è½®è¯¢çŠ¶æ€æ ‡å¿—
        const MAX_POLL_COUNT = 300; // æœ€å¤šè½®è¯¢5åˆ†é’Ÿï¼ˆæ¯2ç§’ä¸€æ¬¡ï¼‰

        // è®°å½•å¼€å§‹æ—¶é—´
        const startTime = Date.now();
        
        // é¡µé¢åŠ è½½æ—¶ç«‹å³åŠ è½½åŸå§‹æ•°æ®
        loadOriginalTableFromFile();

        if (!filename || !uniqueFilename) {
            document.getElementById('resultInfo').innerHTML = '<p style="color: red;">âŒ ç¼ºå°‘æ–‡ä»¶å‚æ•°</p>';
        } else {
            // å¼€å§‹å¤„ç†
            startProcessing();
        }

        function startProcessing() {
            // æ˜¾ç¤ºåŸå§‹æ•°æ®é¢æ¿ï¼Œéšè—ç»“æœé¢æ¿
            document.getElementById('originalPanel').style.display = 'flex';
            document.getElementById('originalPanel').classList.add('full-width');
            document.getElementById('resultPanel').style.display = 'none';
            
            // æ˜¾ç¤ºå¤„ç†ä¸­çš„æç¤º
            document.getElementById('originalTable').innerHTML = 
                `<tbody><tr><td colspan="100%" class="loading">
                    <div class="loading-spinner"></div>
                    <div style="margin-top: 10px;">
                        <strong>æ­£åœ¨å¤„ç†è´¨é‡å·¥å•æ£€æµ‹...</strong><br>
                        <span id="statusText">æ•°æ®å·²ä¸Šä¼ ï¼Œæ­£åœ¨æ’é˜Ÿç­‰å¾…æ£€æµ‹</span>
                    </div>
                </td></tr></tbody>`;
            
            // å¼€å§‹è½®è¯¢æ£€æµ‹çŠ¶æ€
            startPolling();
        }
        
        function startPolling() {
            console.log('å¼€å§‹è½®è¯¢æ£€æµ‹çŠ¶æ€ï¼Œunique_filename:', uniqueFilename);
            
            if (isPollingActive) {
                console.log('âš ï¸ è½®è¯¢å·²åœ¨è¿è¡Œä¸­ï¼Œè·³è¿‡');
                return;
            }
            
            isPollingActive = true;
            
            // ç«‹å³æ£€æŸ¥ä¸€æ¬¡
            checkDetectionStatus();
            
            // æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡
            pollingInterval = setInterval(() => {
                pollCount++;
                
                if (pollCount >= MAX_POLL_COUNT) {
                    stopPolling();
                    showError('æ£€æµ‹è¶…æ—¶ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                    return;
                }
                
                checkDetectionStatus();
            }, 2000);
        }
        
        function stopPolling() {
            console.log('ğŸ›‘ åœæ­¢è½®è¯¢');
            isPollingActive = false;
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
                console.log('âœ… è½®è¯¢intervalå·²æ¸…é™¤');
            }
        }
        
        function checkDetectionStatus() {
            // å¦‚æœè½®è¯¢å·²åœæ­¢ï¼Œä¸å†å‘é€è¯·æ±‚
            if (!isPollingActive || pollingInterval === null) {
                console.log('â¹ï¸ è½®è¯¢å·²åœæ­¢ï¼Œè·³è¿‡è¯·æ±‚');
                return;
            }
            
            fetch('/excel/quality-process', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    filename: filename,
                    original_filename: originalFilename,
                    unique_filename: uniqueFilename
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('æ£€æµ‹çŠ¶æ€:', data);
                
                if (data.status === 'pending') {
                    // æ’é˜Ÿä¸­
                    updateStatus('â³ æ£€æµ‹ä»»åŠ¡æ’é˜Ÿä¸­ï¼Œè¯·ç¨å€™...');
                    
                } else if (data.status === 'processing') {
                    // å¤„ç†ä¸­
                    updateStatus('ğŸ” æ­£åœ¨è¿›è¡ŒAIæ£€æµ‹ï¼Œè¯·ç¨å€™...');
                    
                } else if (data.status === 'completed' && data.success) {
                    // æ£€æµ‹å®Œæˆ - ç«‹å³åœæ­¢è½®è¯¢
                    console.log('âœ… æ£€æµ‹å®Œæˆï¼Œåœæ­¢è½®è¯¢');
                    stopPolling();
                    handleDetectionComplete(data);
                    
                } else if (data.status === 'failed') {
                    // æ£€æµ‹å¤±è´¥ - åœæ­¢è½®è¯¢
                    console.log('âŒ æ£€æµ‹å¤±è´¥ï¼Œåœæ­¢è½®è¯¢');
                    stopPolling();
                    showError('æ£€æµ‹å¤±è´¥ï¼Œè¯·é‡æ–°ä¸Šä¼ æ–‡ä»¶');
                    
                } else if (data.error) {
                    // å…¶ä»–é”™è¯¯
                    console.error('æ£€æµ‹é”™è¯¯:', data.error);
                    // ç»§ç»­è½®è¯¢ï¼Œå¯èƒ½æ•°æ®è¿˜åœ¨å¤„ç†ä¸­
                }
            })
            .catch(error => {
                console.error('æŸ¥è¯¢çŠ¶æ€å¤±è´¥:', error);
                // ç»§ç»­è½®è¯¢ï¼Œä¸ä¸­æ–­
            });
        }
        
        function updateStatus(message) {
            const statusEl = document.getElementById('statusText');
            if (statusEl) {
                statusEl.textContent = message;
            }
        }
        
        function showError(message) {
            // åœæ­¢è½®è¯¢
            stopPolling();
            
            const resultInfo = document.getElementById('resultInfo');
            resultInfo.innerHTML = `<p style="color: red;">âŒ ${message}</p>`;
            document.getElementById('originalTable').innerHTML = 
                `<tbody><tr><td colspan="100%" style="color: red;">âŒ ${message}</td></tr></tbody>`;
        }
        
        function handleDetectionComplete(data) {
            console.log('âœ… è¿›å…¥handleDetectionCompleteï¼Œæ•°æ®:', data);
            
            // ç¡®ä¿è½®è¯¢å·²åœæ­¢
            stopPolling();
            
            // è®¡ç®—å¤„ç†æ—¶é—´
            const endTime = Date.now();
            const processingTime = ((endTime - startTime) / 1000).toFixed(1);

            // æ›´æ–°ç»“æœä¿¡æ¯
            const resultInfo = document.getElementById('resultInfo');
            resultInfo.innerHTML = `
                <h4>âœ… å¤„ç†å®Œæˆ</h4>
                <p><strong>å¤„ç†æ•°æ®è¡Œæ•°:</strong> ${data.rows_processed} è¡Œ</p>
                <p><strong>å®Œæˆæ—¶é—´:</strong> ${new Date().toLocaleString()}</p>
            `;

            // æ˜¾ç¤ºè€—æ—¶ä¿¡æ¯
            document.getElementById('timeDisplay').textContent = `${processingTime}ç§’`;
            document.getElementById('processingTime').style.display = 'block';

            // éšè—åŸå§‹æ•°æ®é¢æ¿ï¼Œæ˜¾ç¤ºç»“æœé¢æ¿
            document.getElementById('originalPanel').style.display = 'none';
            document.getElementById('resultPanel').style.display = 'flex';
            document.getElementById('resultPanel').classList.add('full-width');

            // åŠ è½½ç»“æœè¡¨æ ¼
            loadResultTable(data.csv_filename);
            
            // æ˜¾ç¤ºä¸‹è½½æŒ‰é’®
            const downloadExcel = document.getElementById('downloadExcel');
            const downloadCSV = document.getElementById('downloadCSV');
            
            downloadExcel.href = `/excel/download/${data.excel_filename}`;
            downloadExcel.style.display = 'inline-block';
            
            downloadCSV.href = `/excel/download/${data.csv_filename}`;
            downloadCSV.style.display = 'inline-block';
        }
        
        function loadResultTable(csvFilename) {
            fetch(`/excel/get-result-data/${csvFilename}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayTable('resultTable', data.data, data.columns);
                } else {
                    document.getElementById('resultTable').innerHTML = 
                        `<tbody><tr><td colspan="100%" style="color: red;">âŒ ${data.error}</td></tr></tbody>`;
                }
            })
            .catch(error => {
                console.error('åŠ è½½ç»“æœè¡¨æ ¼å¤±è´¥:', error);
                document.getElementById('resultTable').innerHTML = 
                    `<tbody><tr><td colspan="100%" style="color: red;">âŒ åŠ è½½å¤±è´¥: ${error.message}</td></tr></tbody>`;
            });
        }

        function displayTable(tableId, data, columns) {
            const table = document.getElementById(tableId);
            
            if (!data || data.length === 0) {
                table.innerHTML = '<tbody><tr><td colspan="100%">æš‚æ— æ•°æ®</td></tr></tbody>';
                return;
            }

            let html = '<thead><tr>';
            columns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            html += '</tr></thead><tbody>';

            data.forEach(row => {
                const oldPart = row['æ—§ä»¶åç§°'] || '';
                const newPart = row['æ–°ä»¶åç§°'] || '';
                const needHighlight = oldPart && newPart && oldPart !== newPart;
                html += `<tr class="${needHighlight ? 'diff-highlight' : ''}">`;
                columns.forEach(col => {
                    const cellValue = row[col] || '';
                    const cls = col === 'åˆ¤å®šä¾æ®' ? 'basis-cell' : '';
                    html += `<td class="${cls}" title="${cellValue}">${cellValue}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody>';
            table.innerHTML = html;
        }
        
        // ä»æ•°æ®åº“åŠ è½½åŸå§‹è¡¨æ ¼ï¼ˆæ£€æµ‹æœŸé—´ï¼‰
        function loadOriginalTableFromFile() {
            console.log('å¼€å§‹åŠ è½½åŸå§‹æ•°æ®ï¼Œunique_filename:', uniqueFilename);
            
            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            document.getElementById('resultInfo').innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>æ­£åœ¨åŠ è½½åŸå§‹æ•°æ®...</p>
                </div>
            `;
            
            fetch(`/excel/get-original-data-from-db/${uniqueFilename}`)
            .then(response => response.json())
            .then(data => {
                console.log('åŸå§‹æ•°æ®åŠ è½½å“åº”:', data);
                if (data.success) {
                    displayTable('originalTable', data.data, data.columns);
                    
                    // æ•°æ®åŠ è½½å®Œæˆåï¼Œç«‹å³æ£€æŸ¥æ£€æµ‹çŠ¶æ€
                    checkDetectionStatusOnce();
                } else {
                    showError(data.error || 'åŠ è½½åŸå§‹æ•°æ®å¤±è´¥');
                }
            })
            .catch(error => {
                console.error('åŠ è½½åŸå§‹è¡¨æ ¼å¤±è´¥:', error);
                showError('åŠ è½½åŸå§‹æ•°æ®å¤±è´¥: ' + error.message);
            });
        }
        
        // æ£€æŸ¥ä¸€æ¬¡æ£€æµ‹çŠ¶æ€ï¼ˆå†³å®šæ˜¯æ˜¾ç¤ºåŸå§‹æ•°æ®è¿˜æ˜¯ç»“æœï¼‰
        function checkDetectionStatusOnce() {
            console.log('æ£€æŸ¥å½“å‰æ£€æµ‹çŠ¶æ€...');
            
            fetch('/excel/quality-process', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    filename: filename,
                    original_filename: originalFilename,
                    unique_filename: uniqueFilename
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('å½“å‰æ£€æµ‹çŠ¶æ€:', data);
                
                if (data.status === 'completed' && data.success) {
                    // å·²ç»å®Œæˆï¼Œç›´æ¥æ˜¾ç¤ºç»“æœ
                    console.log('âœ… æ£€æµ‹å·²å®Œæˆï¼Œç›´æ¥æ˜¾ç¤ºç»“æœ');
                    handleDetectionComplete(data);
                } else {
                    // æœªå®Œæˆï¼Œæ˜¾ç¤ºå¤„ç†ä¸­å¹¶å¼€å§‹è½®è¯¢
                    console.log('â³ æ£€æµ‹è¿›è¡Œä¸­ï¼Œå¼€å§‹è½®è¯¢');
                    document.getElementById('resultInfo').innerHTML = `
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            <p id="statusText">å¤§æ¨¡å‹æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...</p>
                        </div>
                    `;
                    startPolling();
                }
            })
            .catch(error => {
                console.error('æŸ¥è¯¢çŠ¶æ€å¤±è´¥:', error);
                // å‡ºé”™æ—¶ä¹Ÿå¯åŠ¨è½®è¯¢
                startPolling();
            });
        }
    </script>
</body>
</html>

