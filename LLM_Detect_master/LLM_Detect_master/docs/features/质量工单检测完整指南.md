# 质量工单检测完整指南

## 📋 目录

1. [功能概述](#功能概述)
2. [判断优化说明](#判断优化说明)
3. [日志功能说明](#日志功能说明)
4. [页面优化说明](#页面优化说明)
5. [使用指南](#使用指南)
6. [故障排除](#故障排除)

---

## 功能概述

质量工单检测系统通过AI智能分析,自动判断工单是否属于质量问题类型,支持批量处理和两阶段推理。

### 核心特性

- ✅ **智能判断**: 基于AI大模型的质量工单自动识别
- ✅ **两阶段推理**: 先推理维修问题点,再判断工单性质
- ✅ **批量处理**: 支持大批量工单数据处理
- ✅ **详细日志**: 完整的处理流程日志输出
- ✅ **后处理机制**: 确保所有工单都有明确判断结果

---

## 判断优化说明

### 问题分析

根据用户反馈,质量工单检测功能存在以下问题:

#### 1. 部分工单未判断
- **现象**: 有些工单的"工单性质"列为空
- **原因**: AI模型输出不完整或格式问题导致某些行缺失判断结果

#### 2. 判断准确率较低
- **现象**: 将质量工单误判为非质量工单,或反之
- **原因**:
  - 提示词不够详细,判断标准不明确
  - AI模型对边界情况处理不当
  - 缺少关键字段的权重说明

### 优化方案

#### 优化1: 增强学习阶段提示词

**文件**: `LLM_Detection_System/prompts/quality_learn_rules.txt`

**优化内容**:
1. ✅ 添加统计分析要求,让AI理解数据分布
2. ✅ 明确特征提取任务,关注关键字段
3. ✅ 详细列出质量工单和非质量工单的典型特征
4. ✅ 强调关键字段的权重和优先级
5. ✅ 提供边界情况的处理原则

**关键改进**:
```
- 判定依据: 最重要的判断线索
- 服务项目或故障现象: 包含"质量鉴定"→质量工单; 包含"安装/调试"→非质量工单
- 关键词识别: 质量工单(坏了、损坏、漏、裂、断、烧、短路)
- 关键词识别: 非质量工单(安装、调试、水压、水质、使用不当)
```

#### 优化2: 增强应用阶段提示词

**文件**: `LLM_Detection_System/prompts/quality_apply_rules.txt`

**优化内容**:
1. ✅ 提供逐行判断的详细步骤
2. ✅ 明确判断优先级(服务项目 > 判定依据 > 其他字段)
3. ✅ 详细列出判断标准和特殊情况处理
4. ✅ 强调输出完整性要求(必须输出所有行,每行都要有判断)
5. ✅ 提供更多输出示例

**判断优先级**:
```
1. 服务项目或故障现象(最重要)
   - 包含"质量鉴定" → 质量工单
   - 包含"安装/调试/加装" → 非质量工单

2. 判定依据
   - 明确说明问题原因

3. 来电内容、现场诊断、处理方案
   - 综合分析问题性质
```

#### 优化3: 添加后处理机制

**文件**: `LLM_Detection_System/modules/excel/processor.py`

**新增功能**:

##### 3.1 `_ensure_quality_judgment()` 方法
确保所有行都有工单性质判断,对空值进行智能填充

**功能**:
- ✅ 检测"工单性质"列的空值
- ✅ 对空值进行智能判断填充
- ✅ 验证判断结果只能是"质量工单"或"非质量工单"
- ✅ 修正异常值

##### 3.2 `_smart_quality_judgment()` 方法
基于规则的智能工单性质判断

**判断逻辑**:
1. **优先检查服务项目字段**
   - 包含"质量鉴定"或"产品质量" → 质量工单
   - 包含"安装"、"调试"、"加装" → 非质量工单

2. **检查判定依据字段**
   - 匹配质量工单关键词 → 质量工单
   - 匹配非质量工单关键词 → 非质量工单

3. **综合所有字段判断**
   - 计算质量工单关键词得分
   - 计算非质量工单关键词得分
   - 比较得分,选择较高的类别

4. **默认策略**
   - 无法判断时,默认为"非质量工单"(保守原则)

**关键词库**:

**质量工单关键词**:
```python
'质量鉴定', '产品质量', '产品缺陷', '制程问题', '来料问题',
'损坏', '坏了', '漏', '裂', '断', '烧', '短路', '失灵',
'不工作', '异响', '故障', '缺陷', '质量问题'
```

**非质量工单关键词**:
```python
'安装', '调试', '加装', '改装', '移机', '维护',
'水压', '水质', '电压', '环境', '使用不当', '操作错误',
'正常损耗', '到期更换', '保养'
```

### 判断标准

#### 【质量工单】- 产品本身的质量问题
- ✓ 零部件损坏、故障、失效
- ✓ 产品缺陷、制程问题、设计缺陷
- ✓ 服务项目包含"质量鉴定"
- ✓ 需要更换零部件且原因是产品质量问题

#### 【非质量工单】- 非产品质量问题
- ✓ 安装、调试、加装、改装、移机等服务
- ✓ 环境因素导致(水压、水质、电压)
- ✓ 用户使用不当、操作错误
- ✓ 正常的维护保养、滤芯到期更换

### 优化效果预期

#### 1. 完整性提升
- ✅ 所有工单都会有明确的性质判断
- ✅ 不再出现空值情况
- ✅ 异常值会被自动修正

#### 2. 准确率提升
- ✅ 更详细的判断标准和示例
- ✅ 明确的字段优先级
- ✅ 基于规则的后处理兜底机制
- ✅ 关键词匹配辅助判断

#### 3. 一致性提升
- ✅ 统一的判断标准
- ✅ 明确的边界情况处理
- ✅ 降低AI模型的随机性(temperature=0.3)

---

## 日志功能说明

### 日志输出内容

系统提供详细的日志输出,涵盖从训练数据加载到最终结果输出的所有关键步骤。

#### 步骤1: 加载训练数据

```
================================================================================
[质量工单检测] 步骤1: 加载训练数据
================================================================================
训练文件: data/训练数据新100条.xlsx
加载状态: ✅ 成功
数据规模: 100行 x 11列
列名: 工单单号, 判定依据, 故障部位名称, 故障组, 故障类别, 服务项目或故障现象, 故障件简称, 来电内容, 现场诊断故障现象, 处理方案简述或备注, 工单性质
--------------------------------------------------------------------------------
```

**输出信息**:
- ✅ 训练文件路径和文件名
- ✅ 加载状态(成功/失败)
- ✅ 数据规模(行数 x 列数)
- ✅ 所有列名
- ❌ 如果加载失败,显示详细错误信息

#### 步骤2: AI学习阶段(第一步推理)

```
================================================================================
[质量工单检测] 步骤2: AI学习阶段(第一步推理)
================================================================================
提示词文件: prompts/quality_learn_rules.txt
提示词长度: 15234 字符
训练数据预览(前200字符):
工单单号,判定依据,故障部位名称,故障组,故障类别,服务项目或故障现象,故障件简称,来电内容,现场诊断故障现象,处理方案简述或备注,工单性质
WO001,产品质量问题,电源适配器,中央净水机,结构故障,产品质量鉴定,布水器,软水机有胶状物,出水嘴故障,布水器坏更换,质量工单...
--------------------------------------------------------------------------------
正在调用AI模型学习判断规律...
✅ AI学习完成
耗时: 12.34 秒
学习结果长度: 2345 字符
Token使用: 输入=3456, 输出=789, 总计=4245
--------------------------------------------------------------------------------
```

**输出信息**:
- ✅ 使用的提示词文件名
- ✅ 提示词长度
- ✅ 训练数据预览(前200字符)
- ✅ AI学习结果预览(前500字符)
- ✅ 处理耗时
- ✅ Token使用统计

#### 步骤3-6: 其他处理步骤

系统会依次输出:
- 步骤3: 加载测试数据
- 步骤4: AI应用阶段(第二步推理 - 推理维修问题点)
- 步骤5: AI应用阶段(第三步推理 - 判断工单性质)
- 步骤6: 数据处理和验证

每个步骤都包含详细的状态信息、数据预览、耗时统计等。

### 日志的用途

#### 1. 监控处理流程
- 实时查看每个步骤的执行状态
- 了解AI模型的处理进度
- 监控处理耗时

#### 2. 调试和排错
- 快速定位问题所在的步骤
- 查看详细的错误堆栈信息
- 验证数据加载和处理是否正确

#### 3. 性能分析
- 查看每个步骤的耗时
- 监控Token使用情况
- 优化处理流程

#### 4. 质量验证
- 检查输入输出行数是否匹配
- 验证空值情况
- 确认CSV格式是否正确

### 使用建议

#### 1. 查看实时日志
在运行质量工单检测时,打开后台控制台(运行 `python LLM_Detection_System/app.py` 的终端窗口),即可看到详细的日志输出。

#### 2. 关注关键指标
- **行数匹配**: 输入行数 = 输出行数
- **空值检查**: 所有行的"工单性质"均已填写
- **耗时监控**: 每个步骤的处理时间
- **Token使用**: 控制API成本

#### 3. 问题排查
如果出现问题,按照以下顺序检查:
1. 训练数据是否成功加载
2. AI学习阶段是否完成
3. 测试数据是否正确加载
4. 推理结果行数是否匹配
5. 是否有空值警告

---

## 页面优化说明

质量工单检测页面已进行优化,提供更好的用户体验:

### 主要优化内容

1. **清晰的操作流程**: 分步骤引导用户完成检测
2. **实时状态反馈**: 显示处理进度和状态
3. **结果可视化**: 直观展示检测结果统计
4. **错误提示**: 友好的错误信息和解决建议

---

## 使用指南

### 快速开始

#### 1. 准备Excel文件

确保Excel文件包含以下字段:
- 工单单号(必填)
- 判定依据
- 故障部位名称
- 故障组
- 故障类别
- 服务项目或故障现象
- 故障件简称
- 来电内容
- 现场诊断故障现象
- 处理方案简述或备注

#### 2. 上传文件

1. 访问 `http://localhost:5000/excel/quality-check`
2. 点击"选择文件"按钮
3. 选择准备好的Excel文件
4. 点击"开始检测"

#### 3. 等待处理

系统会自动:
1. 加载训练数据
2. AI学习判断规律
3. 分析测试数据
4. 推理维修问题点
5. 判断工单性质
6. 生成结果文件

#### 4. 查看结果

处理完成后:
1. 查看检测结果摘要(质量工单数量、非质量工单数量)
2. 下载包含判断结果的Excel文件
3. 结果文件包含"工单性质"列,标注为"质量工单"或"非质量工单"

### 测试验证

#### 完整性验证
- [ ] 所有行的"工单性质"列都有值
- [ ] 没有空值、null、nan等情况
- [ ] 所有值都是"质量工单"或"非质量工单"

#### 准确性验证(抽样检查)
- [ ] 包含"质量鉴定"的工单 → 应判断为"质量工单"
- [ ] 包含"安装"、"调试"的工单 → 应判断为"非质量工单"
- [ ] 零部件损坏、漏水等 → 应判断为"质量工单"
- [ ] 水压、水质、环境问题 → 应判断为"非质量工单"

---

## 故障排除

### 常见问题

#### Q1: 部分工单未判断
**解决方案**: 系统已添加后处理机制,会自动填充空值。如仍有问题,请检查日志输出。

#### Q2: 判断结果不准确
**解决方案**: 
1. 确保Excel文件包含尽可能多的关键字段
2. 检查"服务项目或故障现象"字段是否填写
3. 查看日志中的AI学习结果

#### Q3: 处理时间过长
**解决方案**:
1. 减少测试数据量(建议≤100条)
2. 检查网络连接
3. 查看日志中的耗时统计

#### Q4: 文件上传失败
**解决方案**:
1. 确认文件格式为.xlsx
2. 检查文件大小(建议≤10MB)
3. 验证文件未损坏

---

## 关键改进点总结

### 1. 三层保障机制
- **第一层**: 优化的AI提示词,提高AI判断准确率
- **第二层**: CSV格式验证和修复,确保数据完整性
- **第三层**: 基于规则的后处理,兜底处理空值和异常值

### 2. 明确的判断优先级
```
服务项目或故障现象 > 判定依据 > 其他字段综合判断
```

### 3. 丰富的关键词库
- 质量工单关键词: 18个
- 非质量工单关键词: 15个
- 覆盖常见的故障描述和服务类型

### 4. 保守的默认策略
- 无法明确判断时,默认为"非质量工单"
- 避免误判导致的质量问题遗漏

---

**文档版本**: v2.1  
**最后更新**: 2025-12-02  
**预期效果**: 完整性100%,准确率提升20-30%
