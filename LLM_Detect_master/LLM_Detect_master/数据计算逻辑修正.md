# 🔄 数据计算逻辑修正

## 修改日期
2025-12-15

## 修改原因
根据实际数据库字段值调整计算逻辑

---

## 📊 修改内容

### 1️⃣ 图纸符合率

#### 修改前
```python
# 使用模糊匹配，匹配多个关键词
compliant_drawings = 查询 WHERE conclusion LIKE '%符合%' 
    OR conclusion LIKE '%通过%' 
    OR conclusion LIKE '%合格%'
```

#### 修改后 ✅
```python
# 精确匹配，只匹配'符合'
compliant_drawings = 查询 WHERE conclusion = '符合'
```

#### 原因
- 数据库中 `conclusion` 字段只有两个值：`'符合'` 和 `'不符合'`
- 不需要模糊匹配，直接精确匹配即可

#### 计算公式
```
图纸符合率 = (conclusion='符合'的数量 / status='completed'的总数) × 100%
```

---

### 2️⃣ 工单问题比例

#### 修改前
```python
# 统计质量问题工单占比
quality_issues = 查询 WHERE workOrderNature = '质量问题'
issue_rate = (quality_issues / total_workorders) × 100%
```

#### 修改后 ✅
```python
# 统计非质量工单占比
non_quality_issues = 查询 WHERE workOrderNature != '质量问题'
issue_rate = (non_quality_issues / total_workorders) × 100%
```

#### 原因
- 业务需求是统计**非质量工单**的比例
- 之前统计的是质量问题工单，逻辑相反

#### 计算公式
```
工单问题比例 = (workOrderNature!='质量问题'的数量 / 总工单数) × 100%
```

---

## 🔍 验证方法

### 验证图纸符合率

```sql
-- 查看conclusion字段的所有值
SELECT DISTINCT conclusion, COUNT(*) as count
FROM drawing_data
WHERE status = 'completed'
GROUP BY conclusion;

-- 应该只看到两个值：'符合' 和 '不符合'

-- 计算符合率
SELECT 
    COUNT(*) as total,
    SUM(CASE WHEN conclusion = '符合' THEN 1 ELSE 0 END) as compliant,
    ROUND(SUM(CASE WHEN conclusion = '符合' THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 1) as rate
FROM drawing_data
WHERE status = 'completed';
```

### 验证工单问题比例

```sql
-- 查看workOrderNature字段的所有值
SELECT DISTINCT workOrderNature, COUNT(*) as count
FROM workorder_data
GROUP BY workOrderNature;

-- 计算非质量工单比例
SELECT 
    COUNT(*) as total,
    SUM(CASE WHEN workOrderNature != '质量问题' THEN 1 ELSE 0 END) as non_quality,
    ROUND(SUM(CASE WHEN workOrderNature != '质量问题' THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 1) as rate
FROM workorder_data;
```

---

## 📝 代码变更

### 文件: `modules/common/dashboard_api.py`

#### 变更1: 图纸符合率（第82-97行）
```python
# 3. 图纸符合率（conclusion='符合'的比例）
drawing_rate = 0.0
try:
    completed_drawings = db.session.query(func.count(DrawingData.id)).filter(
        DrawingData.status == 'completed'
    ).scalar() or 0
    
    if completed_drawings > 0:
        # 统计conclusion='符合'的图纸数量
        compliant_drawings = db.session.query(func.count(DrawingData.id)).filter(
            DrawingData.status == 'completed',
            DrawingData.conclusion == '符合'  # ← 改为精确匹配
        ).scalar() or 0
        drawing_rate = round((compliant_drawings / completed_drawings) * 100, 1)
    print(f"[DEBUG] 图纸符合率: {drawing_rate}% (符合: {compliant_drawings}/{completed_drawings})")
except Exception as e:
    print(f"[ERROR] 查询图纸符合率错误: {e}")
```

#### 变更2: 工单问题比例（第103-115行）
```python
# 4. 工单问题比例（非质量工单占总工单的比例）
issue_rate = 0.0
try:
    total_workorders = db.session.query(func.count(WorkorderData.id)).scalar() or 0
    
    if total_workorders > 0:
        # 统计非质量工单数量（workOrderNature != '质量问题'）
        non_quality_issues = db.session.query(func.count(WorkorderData.id)).filter(
            WorkorderData.workOrderNature != '质量问题'  # ← 改为不等于
        ).scalar() or 0
        issue_rate = round((non_quality_issues / total_workorders) * 100, 1)
    print(f"[DEBUG] 工单问题比例: {issue_rate}% (非质量工单: {non_quality_issues}/{total_workorders})")
except Exception as e:
    print(f"[ERROR] 查询工单问题比例错误: {e}")
```

---

## 🚀 部署到服务器

### 步骤1: 备份当前文件
```bash
cp modules/common/dashboard_api.py modules/common/dashboard_api.py.backup
```

### 步骤2: 上传修改后的文件
上传本地的 `dashboard_api.py` 到服务器

### 步骤3: 重启应用
```bash
sudo systemctl restart llm-detection
# 或
pkill -f "python.*app.py" && python app.py
```

### 步骤4: 验证
1. 访问主页，查看数据是否正确
2. 查看服务器日志中的 `[DEBUG]` 信息
3. 运行上面的SQL查询验证

---

## 📊 示例数据

### 图纸符合率示例

假设数据库中有：
- 总共100个已完成的图纸
- 其中85个 `conclusion = '符合'`
- 其中15个 `conclusion = '不符合'`

计算结果：
```
图纸符合率 = 85 / 100 × 100% = 85.0%
```

### 工单问题比例示例

假设数据库中有：
- 总共200个工单
- 其中30个 `workOrderNature = '质量问题'`
- 其中170个 `workOrderNature != '质量问题'`（正常工单、维护工单等）

计算结果：
```
工单问题比例 = 170 / 200 × 100% = 85.0%
```
（表示85%的工单是非质量问题工单）

---

## ⚠️ 注意事项

1. **图纸符合率**
   - 确保 `conclusion` 字段只有 `'符合'` 和 `'不符合'` 两个值
   - 如果有其他值（如空值、其他文本），可能需要额外处理

2. **工单问题比例**
   - 现在统计的是**非质量工单**的比例
   - 数值越高表示质量问题越少（好事）
   - 如果需要改回统计质量问题比例，将 `!=` 改为 `==`

---

## 🔄 如需回滚

如果修改后有问题，恢复备份：
```bash
cp modules/common/dashboard_api.py.backup modules/common/dashboard_api.py
sudo systemctl restart llm-detection
```

---

**修改完成！请重启本地应用测试，确认无误后再部署到服务器。**
