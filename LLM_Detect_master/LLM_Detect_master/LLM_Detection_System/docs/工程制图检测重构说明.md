# å·¥ç¨‹åˆ¶å›¾æ£€æµ‹æ¨¡å—é‡æ„è¯´æ˜

## ğŸ“‹ é‡æ„æ¦‚è¿°

æœ¬æ¬¡é‡æ„å®ç°äº†"ä¸Šä¼ å³æ£€æµ‹"åŠŸèƒ½ï¼Œå¹¶æ·»åŠ äº†é˜Ÿåˆ—æœºåˆ¶é˜²æ­¢å¹¶å‘æ£€æµ‹å†²çªã€‚

**é‡æ„æ—¥æœŸ**: 2025-11-21  
**å½±å“èŒƒå›´**: å·¥ç¨‹åˆ¶å›¾æ£€æµ‹æ¨¡å—ï¼ˆWebç•Œé¢ + OAuth APIï¼‰

---

## ğŸ¯ é‡æ„ç›®æ ‡

### 1. æ•°æ®åº“å­˜å‚¨æ—¶æœºè°ƒæ•´

**æ—§æµç¨‹**:
- ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶ â†’ æ•°æ®ä¸å­˜å…¥æ•°æ®åº“
- ç”¨æˆ·ç‚¹å‡»"å¼€å§‹æ£€æµ‹" â†’ è°ƒç”¨ `/drawing/inspect` æ¥å£
- æ£€æµ‹å®Œæˆ â†’ å°†å®Œæ•´æ•°æ®å­˜å…¥ `drawing_data` è¡¨

**æ–°æµç¨‹**:
- ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶ â†’ **ç«‹å³åˆ›å»ºæ•°æ®åº“è®°å½•**ï¼ˆçŠ¶æ€ï¼špendingï¼‰
- è‡ªåŠ¨åŠ å…¥æ£€æµ‹é˜Ÿåˆ— â†’ é˜Ÿåˆ—æŒ‰FIFOé¡ºåºå¤„ç†
- æ£€æµ‹å®Œæˆ â†’ æ›´æ–°æ•°æ®åº“è®°å½•ï¼ˆçŠ¶æ€ï¼šcompletedï¼‰

### 2. ä¸Šä¼ æ¥å£è°ƒç”¨æ£€æµ‹æ¥å£

**æ—§æµç¨‹**:
- `/drawing/upload` åªè´Ÿè´£ä¿å­˜æ–‡ä»¶
- ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»"å¼€å§‹æ£€æµ‹"æŒ‰é’®
- å‰ç«¯è°ƒç”¨ `/drawing/inspect` æ¥å£

**æ–°æµç¨‹**:
- `/drawing/upload` ä¿å­˜æ–‡ä»¶ + åˆ›å»ºæ•°æ®åº“è®°å½• + åŠ å…¥é˜Ÿåˆ—
- è¿”å› `record_id` ç»™å‰ç«¯
- å‰ç«¯è‡ªåŠ¨å¼€å§‹è½®è¯¢çŠ¶æ€

### 3. å‰ç«¯äº¤äº’æµç¨‹ç®€åŒ–

**æ—§æµç¨‹**:
- ä¸Šä¼ æ–‡ä»¶ â†’ ç‚¹å‡»"å¼€å§‹æ£€æµ‹" â†’ ç­‰å¾…ç»“æœ

**æ–°æµç¨‹**:
- ä¸Šä¼ æ–‡ä»¶ â†’ è‡ªåŠ¨å¼€å§‹æ£€æµ‹ â†’ å®æ—¶æ˜¾ç¤ºçŠ¶æ€

### 4. æ·»åŠ æ£€æµ‹é˜Ÿåˆ—æœºåˆ¶

**æ ¸å¿ƒç‰¹æ€§**:
- âœ… çº¿ç¨‹å®‰å…¨çš„FIFOé˜Ÿåˆ—
- âœ… åŒä¸€æ—¶é—´åªæ‰§è¡Œä¸€ä¸ªæ£€æµ‹ä»»åŠ¡
- âœ… è‡ªåŠ¨æ›´æ–°æ•°æ®åº“çŠ¶æ€
- âœ… æ”¯æŒä»»åŠ¡çŠ¶æ€æŸ¥è¯¢
- âœ… é”™è¯¯å¤„ç†å’Œè¶…æ—¶æœºåˆ¶

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶

1. **`modules/drawing/queue_manager.py`** (æ–°å»º)
   - æ£€æµ‹ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†å™¨
   - å®ç°çº¿ç¨‹å®‰å…¨çš„FIFOé˜Ÿåˆ—
   - è‡ªåŠ¨å¤„ç†æ£€æµ‹ä»»åŠ¡

2. **`migrations/add_status_fields.sql`** (æ–°å»º)
   - æ•°æ®åº“è¿ç§»è„šæœ¬
   - æ·»åŠ  `status`ã€`error_message`ã€`completed_at` å­—æ®µ

3. **`migrations/README.md`** (æ–°å»º)
   - æ•°æ®åº“è¿ç§»è¯´æ˜æ–‡æ¡£

4. **`test_queue_system.py`** (æ–°å»º)
   - é˜Ÿåˆ—ç³»ç»Ÿæµ‹è¯•è„šæœ¬

5. **`docs/å·¥ç¨‹åˆ¶å›¾æ£€æµ‹é‡æ„è¯´æ˜.md`** (æœ¬æ–‡æ¡£)

### ä¿®æ”¹æ–‡ä»¶

1. **`modules/drawing/models.py`**
   - æ·»åŠ  `status`ã€`error_message`ã€`completed_at` å­—æ®µ
   - æ›´æ–° `to_dict()` æ–¹æ³•

2. **`modules/drawing/routes.py`**
   - ä¿®æ”¹ `/upload` æ¥å£ï¼šä¸Šä¼ åç«‹å³åˆ›å»ºæ•°æ®åº“è®°å½•å¹¶åŠ å…¥é˜Ÿåˆ—
   - åºŸå¼ƒ `/inspect` æ¥å£ï¼šæ”¹ä¸ºè¿”å›410çŠ¶æ€ç 
   - æ–°å¢ `/api/status/<record_id>` æ¥å£ï¼šæŸ¥è¯¢æ£€æµ‹çŠ¶æ€
   - æ–°å¢ `/api/queue/info` æ¥å£ï¼šæŸ¥è¯¢é˜Ÿåˆ—ä¿¡æ¯

3. **`templates/drawing_detection.html`**
   - ç§»é™¤"å¼€å§‹æ£€æµ‹"æŒ‰é’®
   - ä¸Šä¼ åè‡ªåŠ¨å¼€å§‹è½®è¯¢çŠ¶æ€
   - æ·»åŠ é˜Ÿåˆ—çŠ¶æ€æ˜¾ç¤º
   - å®ç°çŠ¶æ€è½®è¯¢æœºåˆ¶ï¼ˆæ¯2ç§’æŸ¥è¯¢ä¸€æ¬¡ï¼‰

4. **`modules/api/drawing_api.py`**
   - ä¿®æ”¹ `/upload` æ¥å£ï¼šä¸Webæ¥å£ä¿æŒä¸€è‡´
   - åºŸå¼ƒ `/inspect` æ¥å£ï¼šæ”¹ä¸ºè¿”å›410çŠ¶æ€ç 
   - æ–°å¢ `/status/<record_id>` æ¥å£ï¼šæŸ¥è¯¢æ£€æµ‹çŠ¶æ€

---

## ğŸ”„ æ–°çš„å·¥ä½œæµç¨‹

### Webç•Œé¢æµç¨‹

```
ç”¨æˆ·é€‰æ‹©æ–‡ä»¶
    â†“
å¡«å†™æ£€å…¥è€…å’Œç‰ˆæœ¬
    â†“
ç‚¹å‡»ä¸Šä¼ 
    â†“
åç«¯ä¿å­˜æ–‡ä»¶ + åˆ›å»ºæ•°æ®åº“è®°å½•ï¼ˆstatus=pendingï¼‰
    â†“
åŠ å…¥æ£€æµ‹é˜Ÿåˆ—
    â†“
è¿”å› record_id ç»™å‰ç«¯
    â†“
å‰ç«¯å¼€å§‹è½®è¯¢çŠ¶æ€ï¼ˆæ¯2ç§’ï¼‰
    â†“
é˜Ÿåˆ—å¤„ç†ä»»åŠ¡ï¼ˆstatus=processingï¼‰
    â†“
æ£€æµ‹å®Œæˆï¼ˆstatus=completedï¼‰æˆ–å¤±è´¥ï¼ˆstatus=failedï¼‰
    â†“
å‰ç«¯æ˜¾ç¤ºç»“æœ
```

### APIè°ƒç”¨æµç¨‹

```python
# 1. ä¸Šä¼ æ–‡ä»¶
response = requests.post(
    'http://localhost:5000/api/v1/drawing/upload',
    headers={'Authorization': f'Bearer {access_token}'},
    files={'file': open('drawing.pdf', 'rb')},
    data={
        'checker_name': 'å¼ ä¸‰',
        'version': 'V1.0'
    }
)
record_id = response.json()['record_id']

# 2. è½®è¯¢çŠ¶æ€
while True:
    response = requests.get(
        f'http://localhost:5000/api/v1/drawing/status/{record_id}',
        headers={'Authorization': f'Bearer {access_token}'}
    )
    data = response.json()
    
    if data['status'] == 'completed':
        print(f"æ£€æµ‹å®Œæˆ: {data['conclusion']}")
        break
    elif data['status'] == 'failed':
        print(f"æ£€æµ‹å¤±è´¥: {data['error_message']}")
        break
    else:
        print(f"çŠ¶æ€: {data['status']}")
        time.sleep(2)
```

---

## ğŸ—„ï¸ æ•°æ®åº“å˜æ›´

### æ–°å¢å­—æ®µ

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | é»˜è®¤å€¼ |
|--------|------|------|--------|
| `status` | VARCHAR(50) | æ£€æµ‹çŠ¶æ€ | 'pending' |
| `error_message` | TEXT | é”™è¯¯ä¿¡æ¯ | NULL |
| `completed_at` | VARCHAR(255) | å®Œæˆæ—¶é—´ | NULL |

### çŠ¶æ€å€¼è¯´æ˜

- `pending`: æ’é˜Ÿä¸­ï¼Œç­‰å¾…æ£€æµ‹
- `processing`: æ£€æµ‹ä¸­
- `completed`: æ£€æµ‹å®Œæˆ
- `failed`: æ£€æµ‹å¤±è´¥

### æ–°å¢ç´¢å¼•

- `idx_status`: çŠ¶æ€å­—æ®µç´¢å¼•
- `idx_engineering_drawing_id`: è®°å½•IDç´¢å¼•

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. æ‰§è¡Œæ•°æ®åº“è¿ç§»

```bash
mysql -u root -p angel < migrations/add_status_fields.sql
```

### 2. é‡å¯Flaskåº”ç”¨

```bash
cd LLM_Detection_System
python app.py
```

### 3. éªŒè¯åŠŸèƒ½

è®¿é—® http://localhost:5000/drawing æµ‹è¯•ä¸Šä¼ å’Œæ£€æµ‹åŠŸèƒ½

---

## ğŸ§ª æµ‹è¯•

### æµ‹è¯•é˜Ÿåˆ—ç®¡ç†å™¨

```bash
cd LLM_Detection_System
python test_queue_system.py
```

### æµ‹è¯•Webç•Œé¢

1. è®¿é—® http://localhost:5000/drawing
2. ä¸Šä¼ PDFæ–‡ä»¶
3. è§‚å¯Ÿè‡ªåŠ¨æ£€æµ‹æµç¨‹
4. æŸ¥çœ‹æ£€æµ‹ç»“æœ

### æµ‹è¯•APIæ¥å£

ä½¿ç”¨ `joggle_test.py` æµ‹è¯•OAuth APIæ¥å£

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ•°æ®åº“å¤‡ä»½**: æ‰§è¡Œè¿ç§»å‰è¯·å¤‡ä»½æ•°æ®åº“
2. **ç¯å¢ƒå˜é‡**: ç¡®ä¿ `MOONSHOT_API_KEY` å·²é…ç½®
3. **é˜Ÿåˆ—å•ä¾‹**: é˜Ÿåˆ—ç®¡ç†å™¨ä½¿ç”¨å•ä¾‹æ¨¡å¼ï¼Œå…¨å±€åªæœ‰ä¸€ä¸ªå®ä¾‹
4. **çº¿ç¨‹å®‰å…¨**: é˜Ÿåˆ—æ“ä½œæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯ä»¥å¤„ç†å¹¶å‘è¯·æ±‚
5. **æ–‡ä»¶æ¸…ç†**: æ£€æµ‹å®Œæˆåï¼Œæ–‡ä»¶ä»ä¿ç•™åœ¨ `uploads` ç›®å½•ï¼ˆæœªåˆ é™¤ï¼‰
6. **å‘åå…¼å®¹**: æ—§çš„ `/inspect` æ¥å£å·²åºŸå¼ƒï¼Œè¿”å›410çŠ¶æ€ç 

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

1. **é˜Ÿåˆ—æœºåˆ¶**: é˜²æ­¢å¹¶å‘æ£€æµ‹å¯¼è‡´APIé™æµ
2. **æ•°æ®åº“ç´¢å¼•**: æé«˜çŠ¶æ€æŸ¥è¯¢æ€§èƒ½
3. **è½®è¯¢é—´éš”**: å‰ç«¯æ¯2ç§’æŸ¥è¯¢ä¸€æ¬¡ï¼Œé¿å…é¢‘ç¹è¯·æ±‚
4. **å¼‚æ­¥å¤„ç†**: æ£€æµ‹ä»»åŠ¡åœ¨ç‹¬ç«‹çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šé˜Ÿåˆ—æœªå¯åŠ¨

**ç—‡çŠ¶**: ä¸Šä¼ åçŠ¶æ€ä¸€ç›´æ˜¯ pending

**è§£å†³**: æ£€æŸ¥é˜Ÿåˆ—ç®¡ç†å™¨æ˜¯å¦å¯åŠ¨
```python
from modules.drawing.queue_manager import get_queue_manager
manager = get_queue_manager()
print(manager.get_queue_info())
```

### é—®é¢˜2ï¼šæ£€æµ‹å¤±è´¥

**ç—‡çŠ¶**: çŠ¶æ€å˜ä¸º failed

**è§£å†³**: æŸ¥çœ‹ `error_message` å­—æ®µå’ŒæœåŠ¡å™¨æ—¥å¿—

### é—®é¢˜3ï¼šæ•°æ®åº“å­—æ®µä¸å­˜åœ¨

**ç—‡çŠ¶**: æŠ¥é”™ "Unknown column 'status'"

**è§£å†³**: æ‰§è¡Œæ•°æ®åº“è¿ç§»è„šæœ¬

---

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿã€‚

