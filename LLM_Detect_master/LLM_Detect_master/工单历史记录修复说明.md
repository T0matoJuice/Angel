# 工单历史记录修复说明

## 问题描述
工单历史记录页面只显示通过网页Excel上传的数据，没有显示通过API接口上传的检测历史数据。

## 问题原因
原有实现中，历史记录数据从JSON文件（`excel_history.json`）读取，而只有通过网页上传的Excel文件会调用 `save_excel_history()` 保存到JSON文件。通过API接口上传的数据直接写入数据库，不会保存到JSON文件，因此不会在历史记录中显示。

## 解决方案
将历史记录数据源从JSON文件改为数据库查询，这样可以同时显示通过网页上传和API上传的所有数据。

## 修改内容

### 1. 后端API修改 (`modules/excel/routes.py`)

#### 1.1 修改 `excel_get_history()` 函数
- **位置**: 第471-534行
- **修改内容**:
  - 从数据库 `workorder_data` 表查询历史记录，而不是从JSON文件读取
  - 按文件名分组，统计每个文件的处理行数
  - 按时间倒序排列，限制最多返回100条记录
  - 检查是否存在结果文件（`quality_result_文件名.xlsx`）
  - 返回数据中新增 `has_result_file` 和 `result_filename` 字段

#### 1.2 修改 `excel_get_history_detail()` 函数
- **位置**: 第545-610行
- **修改内容**:
  - 从数据库查询历史记录详情，而不是从JSON文件读取
  - 同样添加结果文件存在性检查
  - 返回数据中新增 `has_result_file` 和 `result_filename` 字段

### 2. 前端页面修改 (`templates/excel_history.html`)

#### 2.1 修改 `displayHistory()` 函数
- **位置**: 第460-503行
- **修改内容**:
  - 根据 `has_result_file` 字段决定是否显示下载按钮
  - 如果有结果文件，显示正常的下载按钮
  - 如果没有结果文件，显示禁用的按钮，提示"无结果文件"

#### 2.2 修改 `showDetailModal()` 函数
- **位置**: 第521-563行
- **修改内容**:
  - 根据 `has_result_file` 字段决定是否显示下载按钮
  - 如果有结果文件，显示下载按钮
  - 如果没有结果文件，显示提示信息："该记录暂无结果文件（通过API接口上传的数据不生成结果文件）"

## 数据库查询逻辑

```python
# 查询当前用户的所有上传记录（按文件名分组）
query = db.session.query(
    WorkorderData.filename,
    WorkorderData.datatime,
    func.count(WorkorderData.id).label('rows_processed')
).filter(
    WorkorderData.account == current_user.username
).group_by(
    WorkorderData.filename,
    WorkorderData.datatime
).order_by(
    desc(WorkorderData.datatime)
).limit(100)
```

## 结果文件检查逻辑

```python
# 检查是否存在结果文件
result_filename = f"quality_result_{filename}"
result_filepath = os.path.join(current_app.config['RESULTS_FOLDER'], result_filename)
has_result_file = os.path.exists(result_filepath)
```

## 返回数据格式

```json
{
    "success": true,
    "records": [
        {
            "id": "文件名的哈希值",
            "filename": "时间戳_原始文件名.xlsx",
            "original_filename": "原始文件名.xlsx",
            "rows_processed": 30,
            "timestamp": "2025-12-18 19:43:45",
            "created_at": "2025-12-18 19:43:45",
            "has_result_file": true,
            "result_filename": "quality_result_时间戳_原始文件名.xlsx"
        }
    ],
    "total": 1
}
```

## 注意事项

1. **通过API上传的数据不生成结果文件**: 这是因为API上传的数据通过队列管理器处理，处理完成后直接更新数据库，不生成Excel结果文件。

2. **通过网页上传的数据生成结果文件**: 网页上传的数据会调用 `excel_process_inference()` 函数，该函数会生成CSV和Excel结果文件。

3. **历史记录ID生成**: 使用文件名的哈希值作为记录ID，确保每个文件有唯一的ID。

4. **结果文件命名规则**: `quality_result_{filename}`，其中 `filename` 是数据库中的文件名（带时间戳）。

## 测试建议

1. 测试通过网页上传Excel文件后，历史记录是否正确显示
2. 测试通过API接口上传数据后，历史记录是否正确显示
3. 测试下载按钮是否根据结果文件存在性正确显示/禁用
4. 测试详情模态框是否正确显示结果文件信息
5. 测试多用户情况下，每个用户只能看到自己的历史记录

## 影响范围

- ✅ 解决了API上传数据不显示在历史记录中的问题
- ✅ 统一了历史记录数据源（从数据库读取）
- ✅ 提供了更好的用户体验（明确标识哪些记录有结果文件）
- ⚠️ 不影响现有功能（向后兼容）
