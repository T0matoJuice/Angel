# 质量工单检测日志功能说明

## 📋 概述

已为质量工单检测功能添加了详细的日志输出，可以在后台控制台实时监控整个处理流程。日志涵盖了从训练数据加载到最终结果输出的所有关键步骤。

---

## 🔍 日志输出内容

### 步骤1: 加载训练数据

```
================================================================================
[质量工单检测] 步骤1: 加载训练数据
================================================================================
训练文件: data/训练数据新100条.xlsx
加载状态: ✅ 成功
数据规模: 100行 x 11列
列名: 工单单号, 判定依据, 故障部位名称, 故障组, 故障类别, 服务项目或故障现象, 故障件简称, 来电内容, 现场诊断故障现象, 处理方案简述或备注, 工单性质
--------------------------------------------------------------------------------
```

**输出信息**：
- ✅ 训练文件路径和文件名
- ✅ 加载状态（成功/失败）
- ✅ 数据规模（行数 x 列数）
- ✅ 所有列名
- ❌ 如果加载失败，显示详细错误信息

---

### 步骤2: AI学习阶段（第一步推理）

```
================================================================================
[质量工单检测] 步骤2: AI学习阶段（第一步推理）
================================================================================
提示词文件: prompts/quality_learn_rules.txt
提示词长度: 15234 字符
训练数据预览（前200字符）:
工单单号,判定依据,故障部位名称,故障组,故障类别,服务项目或故障现象,故障件简称,来电内容,现场诊断故障现象,处理方案简述或备注,工单性质
WO001,产品质量问题,电源适配器,中央净水机,结构故障,产品质量鉴定,布水器,软水机有胶状物,出水嘴故障,布水器坏更换,质量工单...
--------------------------------------------------------------------------------
正在调用AI模型学习判断规律...
✅ AI学习完成
耗时: 12.34 秒
学习结果长度: 2345 字符
学习结果预览（前500字符）:
根据训练数据分析，我总结出以下判断规律：

【质量工单的核心特征】
1. 服务项目明确标注为"质量鉴定"或"产品质量鉴定"
2. 判定依据指向产品本身的质量缺陷...
Token使用: 输入=3456, 输出=789, 总计=4245
--------------------------------------------------------------------------------
```

**输出信息**：
- ✅ 使用的提示词文件名
- ✅ 提示词长度
- ✅ 训练数据预览（前200字符）
- ✅ AI学习结果预览（前500字符）
- ✅ 处理耗时
- ✅ Token使用统计

---

### 步骤3: 加载测试数据

```
================================================================================
[质量工单检测] 步骤3: 加载测试数据
================================================================================
测试文件: uploads/test_data.xlsx
加载状态: ✅ 成功
数据规模: 50行 x 10列
列名: 工单单号, 判定依据, 故障部位名称, 故障组, 故障类别, 服务项目或故障现象, 故障件简称, 来电内容, 现场诊断故障现象, 处理方案简述或备注
✅ 已添加'工单性质'列
预处理后文件: uploads/test_data_processed.xlsx
--------------------------------------------------------------------------------
```

**输出信息**：
- ✅ 测试文件路径
- ✅ 加载状态
- ✅ 数据规模
- ✅ 列名
- ✅ 数据预处理操作（如添加列、重命名列）
- ✅ 预处理后的文件路径

---

### 步骤4: AI应用阶段（第二步推理 - 推理维修问题点）

```
================================================================================
[质量工单检测] 步骤4: AI应用阶段（第二步推理 - 推理维修问题点）
================================================================================
提示词文件: prompts/quality_apply_rules.txt
测试数据行数: 50
提示词长度: 18456 字符
测试数据预览（前200字符）:
工单单号,判定依据,故障部位名称,故障组,故障类别,服务项目或故障现象,故障件简称,来电内容,现场诊断故障现象,处理方案简述或备注,工单性质
WO101,,电源适配器,中央净水机,结构故障,,布水器,软水机有胶状物,出水嘴故障,布水器坏更换,...
--------------------------------------------------------------------------------
正在调用AI模型推理维修问题点...
✅ 维修问题点推理完成
耗时: 15.67 秒
推理结果长度: 8765 字符
推理结果行数: 50 行（预期 50 行）
推理结果预览（前3行）:
  工单单号,判定依据,故障部位名称,故障组,故障类别,服务项目或故障现象,故障件简称,来电内容,现场诊断故障现象,处理方案简述或备注,工单性质
  WO101,产品质量问题导致布水器损坏,电源适配器,中央净水机,结构故障,产品质量鉴定,布水器,软水机有胶状物,出水嘴故障,布水器坏更换,
  WO102,滤芯质量缺陷导致堵塞,滤芯,净水机,滤芯类,线上销售产品质量鉴定,复合滤芯,客户留言:水里有脏东西,制水故障,漏炭更换,
Token使用: 输入=4567, 输出=1234, 总计=5801
--------------------------------------------------------------------------------
```

**输出信息**：
- ✅ 使用的提示词文件名
- ✅ 测试数据行数
- ✅ 提示词长度
- ✅ 测试数据预览
- ✅ 推理结果预览（前3行）
- ✅ 推理结果行数与预期行数对比
- ✅ 处理耗时
- ✅ Token使用统计

---

### 步骤5: AI应用阶段（第三步推理 - 判断工单性质）

```
================================================================================
[质量工单检测] 步骤5: AI应用阶段（第三步推理 - 判断工单性质）
================================================================================
基于上一步的维修问题点推理结果，进行工单性质判断
提示词长度: 9876 字符
提示词关键内容: 基于训练数据学习的规律进行判断
--------------------------------------------------------------------------------
正在调用AI模型判断工单性质...
✅ 工单性质判断完成
耗时: 18.23 秒
判断结果长度: 9234 字符
判断结果行数: 50 行（预期 50 行）
判断结果预览（前3行）:
  工单单号,判定依据,故障部位名称,故障组,故障类别,服务项目或故障现象,故障件简称,来电内容,现场诊断故障现象,处理方案简述或备注,工单性质
  WO101,产品质量问题导致布水器损坏,电源适配器,中央净水机,结构故障,产品质量鉴定,布水器,软水机有胶状物,出水嘴故障,布水器坏更换,质量工单
  WO102,滤芯质量缺陷导致堵塞,滤芯,净水机,滤芯类,线上销售产品质量鉴定,复合滤芯,客户留言:水里有脏东西,制水故障,漏炭更换,质量工单
Token使用: 输入=5678, 输出=1456, 总计=7134
--------------------------------------------------------------------------------
```

**输出信息**：
- ✅ 提示词长度和关键内容
- ✅ 判断结果预览（前3行，包含工单性质）
- ✅ 判断结果行数与预期行数对比
- ✅ 处理耗时
- ✅ Token使用统计

---

### 步骤6: 数据处理和验证

```
================================================================================
[质量工单检测] 步骤6: 数据处理和验证
================================================================================
✅ 已添加CSV表头
正在修复CSV格式...
✅ CSV格式修复完成
正在验证CSV字段数量（预期11列）...
✅ CSV字段验证完成
正在检查'工单性质'列的空值...
✅ 所有 50 行的'工单性质'均已填写
最终输出行数: 50 行
--------------------------------------------------------------------------------
```

**输出信息**：
- ✅ CSV表头添加状态
- ✅ CSV格式修复状态
- ✅ CSV字段数量验证（预期11列）
- ✅ 空值检查结果
  - 如果有空值：显示空值数量和行号
  - 如果无空值：显示确认信息
- ✅ 最终输出行数

---

### 处理完成总结

```
================================================================================
[质量工单检测] 处理完成
================================================================================
✅ 所有步骤已完成
输入数据: 50 行
输出数据: 50 行
总Token使用: 步骤2=5801, 步骤3=7134, 合计=12935
================================================================================
```

**输出信息**：
- ✅ 输入数据行数
- ✅ 输出数据行数
- ✅ 总Token使用统计

---

### 错误处理

如果任何步骤失败，会显示详细的错误信息：

```
================================================================================
❌ 错误: 两阶段推理失败
================================================================================
错误类型: FileNotFoundError
错误信息: [Errno 2] No such file or directory: 'data/训练数据新100条.xlsx'
错误堆栈:
Traceback (most recent call last):
  File "LLM_Detection_System/modules/excel/processor.py", line 383, in learn_quality_rules
    df_training = pd.read_excel(training_excel, dtype=str)
  File "/path/to/pandas/io/excel/_base.py", line 478, in read_excel
    io = ExcelFile(io, storage_options=storage_options, engine=engine)
FileNotFoundError: [Errno 2] No such file or directory: 'data/训练数据新100条.xlsx'
================================================================================
```

**输出信息**：
- ❌ 错误类型
- ❌ 错误信息
- ❌ 完整的错误堆栈

---

## 📊 日志示例（完整流程）

以下是一个完整的处理流程日志示例：

```
================================================================================
[质量工单检测] 步骤1: 加载训练数据
================================================================================
训练文件: data/训练数据新100条.xlsx
加载状态: ✅ 成功
数据规模: 100行 x 11列
列名: 工单单号, 判定依据, 故障部位名称, 故障组, 故障类别, 服务项目或故障现象, 故障件简称, 来电内容, 现场诊断故障现象, 处理方案简述或备注, 工单性质
--------------------------------------------------------------------------------

================================================================================
[质量工单检测] 步骤2: AI学习阶段（第一步推理）
================================================================================
提示词文件: prompts/quality_learn_rules.txt
提示词长度: 15234 字符
训练数据预览（前200字符）:
工单单号,判定依据,故障部位名称,故障组,故障类别,服务项目或故障现象,故障件简称,来电内容,现场诊断故障现象,处理方案简述或备注,工单性质...
--------------------------------------------------------------------------------
正在调用AI模型学习判断规律...
✅ AI学习完成
耗时: 12.34 秒
学习结果长度: 2345 字符
学习结果预览（前500字符）:
根据训练数据分析，我总结出以下判断规律...
Token使用: 输入=3456, 输出=789, 总计=4245
--------------------------------------------------------------------------------

================================================================================
[质量工单检测] 步骤3: 加载测试数据
================================================================================
测试文件: uploads/test_data.xlsx
加载状态: ✅ 成功
数据规模: 50行 x 10列
列名: 工单单号, 判定依据, 故障部位名称, 故障组, 故障类别, 服务项目或故障现象, 故障件简称, 来电内容, 现场诊断故障现象, 处理方案简述或备注
✅ 已添加'工单性质'列
预处理后文件: uploads/test_data_processed.xlsx
--------------------------------------------------------------------------------

================================================================================
[质量工单检测] 步骤4: AI应用阶段（第二步推理 - 推理维修问题点）
================================================================================
提示词文件: prompts/quality_apply_rules.txt
测试数据行数: 50
提示词长度: 18456 字符
测试数据预览（前200字符）:
工单单号,判定依据,故障部位名称,故障组,故障类别,服务项目或故障现象,故障件简称,来电内容,现场诊断故障现象,处理方案简述或备注,工单性质...
--------------------------------------------------------------------------------
正在调用AI模型推理维修问题点...
✅ 维修问题点推理完成
耗时: 15.67 秒
推理结果长度: 8765 字符
推理结果行数: 50 行（预期 50 行）
推理结果预览（前3行）:
  工单单号,判定依据,故障部位名称,故障组,故障类别,服务项目或故障现象,故障件简称,来电内容,现场诊断故障现象,处理方案简述或备注,工单性质
  WO101,产品质量问题导致布水器损坏,电源适配器,中央净水机,结构故障,产品质量鉴定,布水器,软水机有胶状物,出水嘴故障,布水器坏更换,
  WO102,滤芯质量缺陷导致堵塞,滤芯,净水机,滤芯类,线上销售产品质量鉴定,复合滤芯,客户留言:水里有脏东西,制水故障,漏炭更换,
Token使用: 输入=4567, 输出=1234, 总计=5801
--------------------------------------------------------------------------------

================================================================================
[质量工单检测] 步骤5: AI应用阶段（第三步推理 - 判断工单性质）
================================================================================
基于上一步的维修问题点推理结果，进行工单性质判断
提示词长度: 9876 字符
提示词关键内容: 基于训练数据学习的规律进行判断
--------------------------------------------------------------------------------
正在调用AI模型判断工单性质...
✅ 工单性质判断完成
耗时: 18.23 秒
判断结果长度: 9234 字符
判断结果行数: 50 行（预期 50 行）
判断结果预览（前3行）:
  工单单号,判定依据,故障部位名称,故障组,故障类别,服务项目或故障现象,故障件简称,来电内容,现场诊断故障现象,处理方案简述或备注,工单性质
  WO101,产品质量问题导致布水器损坏,电源适配器,中央净水机,结构故障,产品质量鉴定,布水器,软水机有胶状物,出水嘴故障,布水器坏更换,质量工单
  WO102,滤芯质量缺陷导致堵塞,滤芯,净水机,滤芯类,线上销售产品质量鉴定,复合滤芯,客户留言:水里有脏东西,制水故障,漏炭更换,质量工单
Token使用: 输入=5678, 输出=1456, 总计=7134
--------------------------------------------------------------------------------

================================================================================
[质量工单检测] 步骤6: 数据处理和验证
================================================================================
✅ 已添加CSV表头
正在修复CSV格式...
✅ CSV格式修复完成
正在验证CSV字段数量（预期11列）...
✅ CSV字段验证完成
正在检查'工单性质'列的空值...
✅ 所有 50 行的'工单性质'均已填写
最终输出行数: 50 行
--------------------------------------------------------------------------------

================================================================================
[质量工单检测] 处理完成
================================================================================
✅ 所有步骤已完成
输入数据: 50 行
输出数据: 50 行
总Token使用: 步骤2=5801, 步骤3=7134, 合计=12935
================================================================================
```

---

## 🎯 日志的用途

### 1. **监控处理流程**
- 实时查看每个步骤的执行状态
- 了解AI模型的处理进度
- 监控处理耗时

### 2. **调试和排错**
- 快速定位问题所在的步骤
- 查看详细的错误堆栈信息
- 验证数据加载和处理是否正确

### 3. **性能分析**
- 查看每个步骤的耗时
- 监控Token使用情况
- 优化处理流程

### 4. **质量验证**
- 检查输入输出行数是否匹配
- 验证空值情况
- 确认CSV格式是否正确

---

## 💡 使用建议

### 1. **查看实时日志**
在运行质量工单检测时，打开后台控制台（运行 `python LLM_Detection_System/app.py` 的终端窗口），即可看到详细的日志输出。

### 2. **关注关键指标**
- **行数匹配**：输入行数 = 输出行数
- **空值检查**：所有行的"工单性质"均已填写
- **耗时监控**：每个步骤的处理时间
- **Token使用**：控制API成本

### 3. **问题排查**
如果出现问题，按照以下顺序检查：
1. 训练数据是否成功加载
2. AI学习阶段是否完成
3. 测试数据是否正确加载
4. 推理结果行数是否匹配
5. 是否有空值警告

---

## 📝 修改的文件

- ✅ `LLM_Detection_System/modules/excel/processor.py`
  - `learn_quality_rules()` 方法：添加训练数据加载和AI学习阶段的日志
  - `apply_quality_rules()` 方法：添加测试数据加载、AI推理和数据验证的日志
  - `_check_empty_quality()` 方法：优化空值检查的日志输出

---

## ✅ 总结

现在质量工单检测功能具有完整的日志输出系统，可以：
- ✅ 实时监控整个处理流程
- ✅ 查看每个步骤的详细信息
- ✅ 快速定位和排查问题
- ✅ 分析性能和优化处理流程

所有日志都会在后台控制台实时输出，便于调试和监控AI判断的准确性！🎉

