<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥å•å¤„ç†å†å²è®°å½•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
        }

        .back-btn:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            animation: fadeInUp 0.8s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #17a2b8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: #666;
        }

        .empty-state .icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #333;
        }

        .empty-state p {
            font-size: 16px;
            margin-bottom: 30px;
        }

        .start-detection-btn {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .start-detection-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(23, 162, 184, 0.4);
        }

        .history-list {
            display: grid;
            gap: 20px;
        }

        .history-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid #17a2b8;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .history-item:hover {
            background: #e9ecef;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .history-filename {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            flex: 1;
        }

        .history-time {
            font-size: 14px;
            color: #666;
            margin-left: 20px;
        }

        .history-status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-left: 15px;
            background: #d4edda;
            color: #155724;
        }

        .history-info {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .view-detail-btn {
            background: #17a2b8;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .view-detail-btn:hover {
            background: #138496;
        }

        .download-btn {
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .download-btn:hover {
            background: #5a6268;
        }

        /* è¯¦æƒ…æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 0;
            border-radius: 15px;
            width: 95%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            animation: slideIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            padding: 30px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .detail-section {
            margin-bottom: 25px;
        }

        .detail-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .detail-content {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #17a2b8;
            line-height: 1.6;
        }

        .download-section {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .download-result-btn {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 30px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .download-result-btn:hover {
            background: linear-gradient(135deg, #138496 0%, #117a8b 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 24px;
            }

            .content {
                padding: 20px;
            }

            .history-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .history-time {
                margin-left: 0;
            }

            .modal-content {
                width: 95%;
                margin: 10% auto;
            }

            .modal-body {
                padding: 20px;
            }
        }
    </style>
</head>

<body>
    <a href="/excel" class="back-btn">
        <span>â†</span>
        <span>è¿”å›è´¨é‡å·¥å•æ£€æµ‹ç³»ç»Ÿ</span>
    </a>

    <div class="container">
        <div class="header">
            <h1>ğŸ“‹ å·¥å•å¤„ç†å†å²è®°å½•</h1>
            <p>æŸ¥çœ‹æœ€è¿‘çš„å·¥å•å¤„ç†è®°å½•å’Œç»“æœæ–‡ä»¶</p>
        </div>

        <div class="content">
            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="showAllCheckbox" onchange="toggleShowAll()"
                            style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-size: 14px; color: #666;">æ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·çš„è®°å½•ï¼ˆåŒ…æ‹¬APIä¸Šä¼ ï¼‰</span>
                    </label>
                </div>
                <div id="userInfo" style="font-size: 14px; color: #666;">
                    <!-- å½“å‰ç”¨æˆ·ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
            <div id="historyContent">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>æ­£åœ¨åŠ è½½å†å²è®°å½•...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">å¤„ç†è¯¦æƒ…</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- è¯¦æƒ…å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
            </div>
        </div>
    </div>

    <script>
        // é¡µé¢åŠ è½½å®Œæˆåè·å–å†å²è®°å½•
        document.addEventListener('DOMContentLoaded', function () {
            loadHistory();
        });

        // åˆ‡æ¢æ˜¾ç¤ºæ‰€æœ‰è®°å½•
        function toggleShowAll() {
            loadHistory();
        }

        // åŠ è½½å†å²è®°å½•
        function loadHistory() {
            const showAll = document.getElementById('showAllCheckbox').checked;
            const url = showAll ? '/excel/api/history?show_all=1' : '/excel/api/history';

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayHistory(data.records);
                        // æ˜¾ç¤ºå½“å‰ç”¨æˆ·ä¿¡æ¯
                        const userInfo = document.getElementById('userInfo');
                        if (data.show_all) {
                            userInfo.innerHTML = `å½“å‰ç”¨æˆ·: <strong>${data.current_user}</strong> | æ˜¾ç¤º: <strong>æ‰€æœ‰ç”¨æˆ·</strong>`;
                        } else {
                            userInfo.innerHTML = `å½“å‰ç”¨æˆ·: <strong>${data.current_user}</strong> | æ˜¾ç¤º: <strong>ä»…æˆ‘çš„è®°å½•</strong>`;
                        }
                    } else {
                        showError('è·å–å†å²è®°å½•å¤±è´¥: ' + data.error);
                    }
                })
                .catch(error => {
                    showError('ç½‘ç»œé”™è¯¯: ' + error.message);
                });
        }

        // æ˜¾ç¤ºå†å²è®°å½•åˆ—è¡¨
        function displayHistory(records) {
            const content = document.getElementById('historyContent');

            if (!records || records.length === 0) {
                content.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ğŸ“Š</div>
                        <h3>æš‚æ— å¤„ç†è®°å½•</h3>
                        <p>æ‚¨è¿˜æ²¡æœ‰è¿›è¡Œè¿‡å·¥å•å¤„ç†ï¼Œå¼€å§‹ç¬¬ä¸€æ¬¡å¤„ç†å§ï¼</p>
                        <a href="/excel/detection" class="start-detection-btn">å¼€å§‹å¤„ç†</a>
                    </div>
                `;
                return;
            }

            let html = '<div class="history-list">';

            records.forEach(record => {
                // æ ¹æ®æ˜¯å¦æœ‰ç»“æœæ–‡ä»¶å†³å®šä¸‹è½½æŒ‰é’®çš„æ˜¾ç¤º
                const downloadButton = record.has_result_file
                    ? `<button class="download-btn" onclick="event.stopPropagation(); downloadResult('${record.result_filename}')">
                           ğŸ“¥ ä¸‹è½½ç»“æœ
                       </button>`
                    : `<button class="download-btn" style="opacity: 0.5; cursor: not-allowed;" disabled title="è¯¥è®°å½•æš‚æ— ç»“æœæ–‡ä»¶">
                           ğŸ“¥ æ— ç»“æœæ–‡ä»¶
                       </button>`;

                html += `
                    <div class="history-item" onclick="viewDetail('${record.id}')">
                        <div class="history-header">
                            <div class="history-filename">${record.original_filename}</div>
                            <div>
                                <span class="history-status">å¤„ç†å®Œæˆ</span>
                                <div class="history-time">${record.timestamp}</div>
                            </div>
                        </div>
                        <div class="history-info">
                            è´¦å·: <strong>${record.account}</strong> | 
                            å¤„ç†è¡Œæ•°: ${record.rows_processed} è¡Œ | 
                            ç»“æœæ–‡ä»¶: ${record.filename}
                        </div>
                        <div class="button-group">
                            <button class="view-detail-btn" onclick="event.stopPropagation(); viewDetail('${record.id}')">
                                æŸ¥çœ‹è¯¦æƒ…
                            </button>
                            ${downloadButton}
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            content.innerHTML = html;
        }

        // æŸ¥çœ‹è¯¦æƒ…
        function viewDetail(recordId) {
            fetch(`/excel/api/history/${recordId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showDetailModal(data.record);
                    } else {
                        alert('è·å–è¯¦æƒ…å¤±è´¥: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('ç½‘ç»œé”™è¯¯: ' + error.message);
                });
        }

        // æ˜¾ç¤ºè¯¦æƒ…æ¨¡æ€æ¡†
        function showDetailModal(record) {
            const modal = document.getElementById('detailModal');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');

            title.textContent = `å¤„ç†è¯¦æƒ… - ${record.original_filename}`;

            // æ ¹æ®æ˜¯å¦æœ‰ç»“æœæ–‡ä»¶å†³å®šä¸‹è½½æŒ‰é’®çš„æ˜¾ç¤º
            const downloadSection = record.has_result_file
                ? `<div class="download-section">
                       <button class="download-result-btn" onclick="downloadResult('${record.result_filename}')">
                           ğŸ“¥ ä¸‹è½½å¤„ç†ç»“æœ
                       </button>
                   </div>`
                : `<div class="download-section">
                       <p style="color: #666; font-size: 14px;">è¯¥è®°å½•æš‚æ— ç»“æœæ–‡ä»¶ï¼ˆé€šè¿‡APIæ¥å£ä¸Šä¼ çš„æ•°æ®ä¸ç”Ÿæˆç»“æœæ–‡ä»¶ï¼‰</p>
                   </div>`;

            body.innerHTML = `
                <div class="detail-section">
                    <div class="detail-label">åŸå§‹æ–‡ä»¶å</div>
                    <div class="detail-content">${record.original_filename}</div>
                </div>
                
                <div class="detail-section">
                    <div class="detail-label">å¤„ç†æ—¶é—´</div>
                    <div class="detail-content">${record.timestamp}</div>
                </div>
                
                <div class="detail-section">
                    <div class="detail-label">å¤„ç†çŠ¶æ€</div>
                    <div class="detail-content">å¤„ç†å®Œæˆ</div>
                </div>
                
                <div class="detail-section">
                    <div class="detail-label">å¤„ç†ç»“æœ</div>
                    <div class="detail-content">æˆåŠŸå¤„ç† ${record.rows_processed} è¡Œæ•°æ®</div>
                </div>
                
                <div class="detail-section">
                    <div class="detail-label">ç»“æœæ–‡ä»¶</div>
                    <div class="detail-content">${record.filename}</div>
                </div>
                
                ${downloadSection}
            `;

            modal.style.display = 'block';
        }

        // ä¸‹è½½ç»“æœæ–‡ä»¶
        function downloadResult(filename) {
            window.location.href = `/excel/download/${filename}`;
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function (event) {
            const modal = document.getElementById('detailModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const content = document.getElementById('historyContent');
            content.innerHTML = `
                <div class="empty-state">
                    <div class="icon">âŒ</div>
                    <h3>åŠ è½½å¤±è´¥</h3>
                    <p>${message}</p>
                    <button class="start-detection-btn" onclick="loadHistory()">é‡è¯•</button>
                </div>
            `;
        }
    </script>
</body>

</html>